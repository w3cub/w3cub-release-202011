
<!DOCTYPE HTML>

<html lang="en" class="_theme-default">

<head>
  <meta charset="utf-8">
  <title>Streams API&#58; Using Readable Byte Streams - Web APIs - W3cubDocs</title>
  
  <meta name="description" content="Readable byte streams are readable streams that have an underlying byte source of type&#58; &#34;bytes&#34;, and which support efficient zero-copy &hellip;">
  <meta name="keywords" content="using, readable, byte, streams, api, web, apis, dom">
  <meta name="HandheldFriendly" content="True">
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <meta name="mobile-web-app-capable" content="yes">
  
  <link rel="canonical" href="https://docs.w3cub.com/dom/streams_api/using_readable_byte_streams.html">
  <link href="/favicon.png" rel="icon">
  <link rel="stylesheet" type="text/css" href="/assets/application-9c7b0d969c0ce639a6c01c2badcdd81667c7c66206aa3d0fccc5cb0585fb1b912dab72ea882101d18010680927514b4b77b107282db8f756fbf63301fe9c88b0.css">
  <script type="text/javascript" src="/assets/application-79c555f6b25481fffac2cac30a7f3e54e608ca09e9e8e42bb1790095ba6d0fcace47d6bc624ddce952c70370892f2d46864f89e6943d4f7f7ff16c8a3231a91a.js"></script>
  <script src="/json/dom.js"></script>
  
<!-- Google tag (gtag.js) -->
<script async src="https://www.googletagmanager.com/gtag/js?id=G-R3WC07G3GB"></script>
<script>
  window.dataLayer = window.dataLayer || [];
  function gtag(){dataLayer.push(arguments);}
  gtag('js', new Date());
  gtag('config', 'G-R3WC07G3GB');
</script>
<script async src="https://pagead2.googlesyndication.com/pagead/js/adsbygoogle.js?client=ca-pub-2572770204602497"
     crossorigin="anonymous"></script>
<script async custom-element="amp-auto-ads"
  src="https://cdn.ampproject.org/v0/amp-auto-ads-0.1.js">
</script>


</head>

<body class="docs">
	<amp-auto-ads type="adsense"
              data-ad-client="ca-pub-2572770204602497">
	</amp-auto-ads>
	<div class="_app">
	<header class="_header">

  <a class="_home-link" href="/" ></a>
  <a class="_menu-link"></a>
  <h1 class="_logo">
    <a href="/" class="_nav-link" title="API Documentation Browser">W3cubDocs</a>
  </h1>
  
  <span class="_logo-sub-nav">/</span><span class="_logo-sub-nav"><a href="/dom/" class="_nav-link" title="" style="margin-left:0;">Web APIs</a></span>
  
  <nav class="_nav">
    <a href="https://tools.w3cub.com/?_sp=docs" target="_blank" class="_nav-link ">W3cubTools</a>
    <a href="/cheatsheets/" class="_nav-link ">Cheatsheets</a>
    <a href="/about/" class="_nav-link ">About</a>
  </nav>
</header>
	<section class="_sidebar">
		
		<form class="_search">
		  <input type="search" class="_search-input" placeholder="Search&hellip;" autocomplete="off" autocapitalize="off" autocorrect="off" spellcheck="false" maxlength="20">
		  <a class="_search-clear"></a>
		  <div class="_search-tag"></div>
		</form>
		
		<div class="_list-wrap">
			<div class="_list">
			
			</div>
		</div>
	</section>
	<section class="_container ">
		<div class="_content">
			<ins class="adsbygoogle"
     style="display:block"
     data-ad-client="ca-pub-2572770204602497"
     data-ad-slot="6861657091"
     data-ad-format="auto"
     data-full-width-responsive="true"></ins>
<script>
     (adsbygoogle = window.adsbygoogle || []).push({});
</script>
			<div class="_page _mdn">
				
				
<h1>Using readable byte streams</h1>
<div class="section-content">
<p> Readable <em>byte streams</em> are <a href="using_readable_streams">readable streams</a> that have an underlying byte source of <code>type: "bytes"</code>, and which support efficient zero-copy transfer of data from the underlying source to a consumer (bypassing the stream's internal queues). They are intended for use cases where data might be supplied or requested in arbitrary sized and potentially very large chunks, and hence where avoiding making copies is likely to improve efficiency. </p> <p>This article explains how readable byte streams compare to normal "default" streams, and how you create and consume them.</p> <div class="notecard note" id="sect1"> <p> <strong>Note:</strong> Readable byte streams are almost identical to "normal" readable streams and almost all of the concepts are the same. This article assumes that you already understand those concepts and will only be covering them superficially (if at all). If you're not familiar with the relevant concepts, please first read: <a href="using_readable_streams">Using readable streams</a>, <a href="../streams_api#concepts_and_usage">Streams concepts and usage overview</a>, and <a href="concepts">Streams API concepts</a>. </p> </div>
</div>
<h2 id="overview">Overview</h2>
<div class="section-content">
<p> Readable streams provides a consistent interface for streaming data from some underlying source, such as a file or socket, to a consumer, such as a reader, transform stream or writable stream. In a normal readable stream, data from the underlying source always passes to a consumer through the internal queues. A readable byte stream differs in that if the internal queues are empty, the underlying source can write directly to the consumer (an efficient zero-copy transfer). </p> <p> A readable byte stream is created by specifying <code>type: "bytes"</code> in the <code>underlyingSource</code> object that may be passed as the first parameter to the <a href="../readablestream/readablestream"><code>ReadableStream()</code> constructor</a>. With this value set, the stream is created with a <a href="../readablebytestreamcontroller"><code>ReadableByteStreamController</code></a>, and this is the object that is passed to the underlying source when the <code>start(controller)</code> and <code>pull(controller)</code> callback functions are invoked. </p> <p> The main difference between <a href="../readablebytestreamcontroller"><code>ReadableByteStreamController</code></a> and the default controller (<a href="../readablestreamdefaultcontroller"><code>ReadableStreamDefaultController</code></a>) is that it has an additional property <a href="../readablebytestreamcontroller/byobrequest"><code>ReadableByteStreamController.byobRequest</code></a> of type <a href="../readablestreambyobrequest"><code>ReadableStreamBYOBRequest</code></a>. This represents a pending read request by a consumer that will be made as a zero-copy transfer from the underlying source. The property will be <code>null</code> if there is no pending request. </p> <p>A <code>byobRequest</code> is only made available when a read request is made on a readable byte stream and there is no data in the stream's internal queues (if there is data then the request is satisfied from those queues).</p> <p> An underlying byte source that needs to transfer data must check the <code>byobRequest</code> property and, if it is available, use it to transfer data. If the property is <code>null</code>, incoming data should instead be added to the stream's internal queues using <a href="../readablebytestreamcontroller/enqueue"><code>ReadableByteStreamController.enqueue()</code></a> (this is the only way to transfer data when using a "default" stream). </p> <p> The <a href="../readablestreambyobrequest"><code>ReadableStreamBYOBRequest</code></a> has a <a href="../readablestreambyobrequest/view"><code>view</code></a> property, which is a view on the buffer allocated for transfer. Data from an underlying source should be written into this property, and then the underlying source must call <a href="../readablestreambyobrequest/respond"><code>respond()</code></a> indicating the number of bytes written. This signals that the data should be transferred, and the pending read request by the consumer resolved. After calling <code>respond()</code> the <code>view</code> can no longer be written. </p> <p> There is also an additional method <a href="../readablestreambyobrequest/respondwithnewview"><code>ReadableStreamBYOBRequest.respondWithNewView()</code></a> to which an underlying source can pass a "new" view containing data to be transferred. This new view must be over the <em>same</em> memory buffer as the original, and from the same starting offset. This method might be used if the underlying byte source needs to first transfer the view to a worker thread to populate (for example) and then get it back before responding to the <code>byobRequest</code>. In most cases this method will not be needed. </p> <p>Readable byte streams are normally read using a <a href="../readablestreambyobreader"><code>ReadableStreamBYOBReader</code></a>, which can be obtained by calling <a href="../readablestream/getreader"><code>ReadableStream.getReader()</code></a> on the stream, specifying <code>mode: "byob"</code> in the options parameter.</p> <p> A readable byte stream can also be read using a default reader (<a href="../readablestreamdefaultreader"><code>ReadableStreamDefaultReader</code></a>), but in this case <code>byobRequest</code> objects are only created when automatic buffer allocation is enabled for the stream (<a href="../readablestream/readablestream#autoallocatechunksize"><code>autoAllocateChunkSize</code></a> was set for the stream's <code>underlyingSource</code>). Note that the size indicated by <code>autoAllocateChunkSize</code> is used for the buffer size in this case; for a byte reader the buffer used is supplied by the consumer. If the property was not specified, the default reader will still "work" but the underlying source will never be offered a <code>byobRequest</code>, and all data will be transferred through the stream's internal queues. </p> <p>Other than the differences outlined above, the controller and underlying source for bytes streams are very similar to those for default streams, <a href="using_readable_streams">and are used in much the same way</a>.</p>
</div>
<h2 id="examples">Examples</h2>

<h3 id="underlying_push_source_with_byte_reader">Underlying push source with byte reader</h3>
<div class="section-content">
<p>This live example shows how to create a readable byte stream with a <em>push</em> underlying byte source, and read it using a byte reader.</p> <p> Unlike with a pull underlying byte source, data can arrive at any time. Therefore the underlying source must use <code>controller.byobRequest</code> to transfer incoming data if one exists, and otherwise enqueue the data into the stream's internal queues. Further, since the data can arrive at any time the monitoring behavior is set up in the <code>underlyingSource.start()</code> callback function. </p> <p> The example is highly influenced by a push byte source example in the stream specification. It uses a mocked "hypothetical socket" source that supplies data of arbitrary sizes. The reader is deliberately delayed at various points to allow the underlying source to use both transfer and enqueuing to send data to the stream. Backpressure support is not demonstrated. </p> <div class="notecard note" id="sect2"> <p> <strong>Note:</strong> An underlying byte source can also be used with a default reader. If automatic buffer allocation is enabled the controller will supply fixed-size buffers for zero-copy transfers when there is an outstanding request from a reader and the stream's internal queues are empty. If automatic buffer allocation is not enabled then all data from the byte stream will always be enqueued. This is similar to the behavior shown in the "pull: underlying byte source examples. </p> </div> <h4 id="mocked_underlying_socket_source">Mocked underlying socket source</h4> <p>The mocked underlying source has three important methods:</p> <ul> <li> <code>select2()</code> represents an outstanding request on the socket. It returns a promise that is resolved when data is available. </li> <li>
<code>readInto()</code> reads data from the socket into a supplied buffer and then clears the data.</li> <li>
<code>close()</code> closes the socket.</li> </ul> <p> The implementation is very simplistic. As shown below, <code>select2()</code> creates a randomly sized buffer of random data on a timeout. The created data is read into a buffer then cleared in <code>readInto()</code>. </p> <div class="code-example"><pre data-language="js"><span class="token keyword">class</span> <span class="token class-name">MockHypotheticalSocket</span> <span class="token punctuation">{</span>
  <span class="token function">constructor</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">this</span><span class="token punctuation">.</span>max_data <span class="token operator">=</span> <span class="token number">800</span><span class="token punctuation">;</span> <span class="token comment">// total amount of data to stream from "socket"</span>
    <span class="token keyword">this</span><span class="token punctuation">.</span>max_per_read <span class="token operator">=</span> <span class="token number">100</span><span class="token punctuation">;</span> <span class="token comment">// max data per read</span>
    <span class="token keyword">this</span><span class="token punctuation">.</span>min_per_read <span class="token operator">=</span> <span class="token number">40</span><span class="token punctuation">;</span> <span class="token comment">// min data per read</span>
    <span class="token keyword">this</span><span class="token punctuation">.</span>data_read <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span> <span class="token comment">// total data read so far (capped is maxdata)</span>
    <span class="token keyword">this</span><span class="token punctuation">.</span>socketdata <span class="token operator">=</span> <span class="token keyword">null</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>

  <span class="token comment">// Method returning promise when this socket is readable.</span>
  <span class="token function">select2</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token comment">// Object used to resolve promise</span>
    <span class="token keyword">const</span> resultobj <span class="token operator">=</span> <span class="token punctuation">{</span><span class="token punctuation">}</span><span class="token punctuation">;</span>
    resultobj<span class="token punctuation">[</span><span class="token string">"bytesRead"</span><span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span>

    <span class="token keyword">return</span> <span class="token keyword">new</span> <span class="token class-name">Promise</span><span class="token punctuation">(</span><span class="token punctuation">(</span>resolve <span class="token comment">/*, reject*/</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
      <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">.</span>data_read <span class="token operator">&gt;=</span> <span class="token keyword">this</span><span class="token punctuation">.</span>max_data<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token comment">//out of data</span>
        <span class="token function">resolve</span><span class="token punctuation">(</span>resultobj<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">return</span><span class="token punctuation">;</span>
      <span class="token punctuation">}</span>

      <span class="token comment">// Emulate slow read of data</span>
      <span class="token function">setTimeout</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
        <span class="token keyword">const</span> numberBytesReceived <span class="token operator">=</span> <span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">getNumberRandomBytesSocket</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">this</span><span class="token punctuation">.</span>data_read <span class="token operator">+=</span> numberBytesReceived<span class="token punctuation">;</span>
        <span class="token keyword">this</span><span class="token punctuation">.</span>socketdata <span class="token operator">=</span> <span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">randomByteArray</span><span class="token punctuation">(</span>numberBytesReceived<span class="token punctuation">)</span><span class="token punctuation">;</span>
        resultobj<span class="token punctuation">[</span><span class="token string">"bytesRead"</span><span class="token punctuation">]</span> <span class="token operator">=</span> numberBytesReceived<span class="token punctuation">;</span>
        <span class="token function">resolve</span><span class="token punctuation">(</span>resultobj<span class="token punctuation">)</span><span class="token punctuation">;</span>
      <span class="token punctuation">}</span><span class="token punctuation">,</span> <span class="token number">500</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>

  <span class="token comment">/* Read data into specified buffer offset */</span>
  <span class="token function">readInto</span><span class="token punctuation">(</span><span class="token parameter">buffer<span class="token punctuation">,</span> offset<span class="token punctuation">,</span> length</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">let</span> length_data <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">.</span>socketdata<span class="token punctuation">)</span> <span class="token punctuation">{</span>
      length_data <span class="token operator">=</span> <span class="token keyword">this</span><span class="token punctuation">.</span>socketdata<span class="token punctuation">.</span>length<span class="token punctuation">;</span>
      <span class="token keyword">const</span> myview <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Uint8Array</span><span class="token punctuation">(</span>buffer<span class="token punctuation">,</span> offset<span class="token punctuation">,</span> length<span class="token punctuation">)</span><span class="token punctuation">;</span>
      <span class="token comment">// Write the length of data specified into buffer</span>
      <span class="token comment">// Code assumes buffer always bigger than incoming data</span>
      <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token keyword">let</span> i <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span> i <span class="token operator">&lt;</span> length_data<span class="token punctuation">;</span> i<span class="token operator">++</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        myview<span class="token punctuation">[</span>i<span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token keyword">this</span><span class="token punctuation">.</span>socketdata<span class="token punctuation">[</span>i<span class="token punctuation">]</span><span class="token punctuation">;</span>
      <span class="token punctuation">}</span>
      <span class="token keyword">this</span><span class="token punctuation">.</span>socketdata <span class="token operator">=</span> <span class="token keyword">null</span><span class="token punctuation">;</span> <span class="token comment">// Clear "socket" data after reading</span>
    <span class="token punctuation">}</span>
    <span class="token keyword">return</span> length_data<span class="token punctuation">;</span>
  <span class="token punctuation">}</span>

  <span class="token comment">// Dummy close function</span>
  <span class="token function">close</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">return</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>

  <span class="token comment">// Return random number bytes in this call of socket</span>
  <span class="token function">getNumberRandomBytesSocket</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token comment">// Capped to remaining data and the max min return-per-read range</span>
    <span class="token keyword">const</span> remaining_data <span class="token operator">=</span> <span class="token keyword">this</span><span class="token punctuation">.</span>max_data <span class="token operator">-</span> <span class="token keyword">this</span><span class="token punctuation">.</span>data_read<span class="token punctuation">;</span>
    <span class="token keyword">const</span> numberBytesReceived <span class="token operator">=</span>
      remaining_data <span class="token operator">&lt;</span> <span class="token keyword">this</span><span class="token punctuation">.</span>min_per_read
        <span class="token operator">?</span> remaining_data
        <span class="token operator">:</span> <span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">getRandomIntInclusive</span><span class="token punctuation">(</span>
            <span class="token keyword">this</span><span class="token punctuation">.</span>min_per_read<span class="token punctuation">,</span>
            Math<span class="token punctuation">.</span><span class="token function">min</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">.</span>max_per_read<span class="token punctuation">,</span> remaining_data<span class="token punctuation">)</span>
          <span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">return</span> numberBytesReceived<span class="token punctuation">;</span>
  <span class="token punctuation">}</span>

  <span class="token comment">// Return random number between two values</span>
  <span class="token function">getRandomIntInclusive</span><span class="token punctuation">(</span><span class="token parameter">min<span class="token punctuation">,</span> max</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    min <span class="token operator">=</span> Math<span class="token punctuation">.</span><span class="token function">ceil</span><span class="token punctuation">(</span>min<span class="token punctuation">)</span><span class="token punctuation">;</span>
    max <span class="token operator">=</span> Math<span class="token punctuation">.</span><span class="token function">floor</span><span class="token punctuation">(</span>max<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">return</span> Math<span class="token punctuation">.</span><span class="token function">floor</span><span class="token punctuation">(</span>Math<span class="token punctuation">.</span><span class="token function">random</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">*</span> <span class="token punctuation">(</span>max <span class="token operator">-</span> min <span class="token operator">+</span> <span class="token number">1</span><span class="token punctuation">)</span> <span class="token operator">+</span> min<span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>

  <span class="token comment">// Return random character string</span>
  <span class="token function">randomChars</span><span class="token punctuation">(</span><span class="token parameter">length <span class="token operator">=</span> <span class="token number">8</span></span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">let</span> string <span class="token operator">=</span> <span class="token string">""</span><span class="token punctuation">;</span>
    <span class="token keyword">let</span> choices <span class="token operator">=</span>
      <span class="token string">"ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz0123456789!@#$%^&amp;*()"</span><span class="token punctuation">;</span>

    <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token keyword">let</span> i <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span> i <span class="token operator">&lt;</span> length<span class="token punctuation">;</span> i<span class="token operator">++</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
      string <span class="token operator">+=</span> choices<span class="token punctuation">.</span><span class="token function">charAt</span><span class="token punctuation">(</span>Math<span class="token punctuation">.</span><span class="token function">floor</span><span class="token punctuation">(</span>Math<span class="token punctuation">.</span><span class="token function">random</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">*</span> choices<span class="token punctuation">.</span>length<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
    <span class="token keyword">return</span> string<span class="token punctuation">;</span>
  <span class="token punctuation">}</span>

  <span class="token comment">/* Return random Uint8Array of bytes */</span>
  <span class="token function">randomByteArray</span><span class="token punctuation">(</span><span class="token parameter">bytes <span class="token operator">=</span> <span class="token number">8</span></span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">const</span> textEncoder <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">TextEncoder</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">return</span> textEncoder<span class="token punctuation">.</span><span class="token function">encode</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">randomChars</span><span class="token punctuation">(</span>bytes<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</pre></div>    <h4 id="creating_a_readable_socket_push_byte_stream">Creating a readable socket push byte stream</h4> <p>The following code shows how to define a readable socket "push" byte stream.</p> <p> The <code>underlyingSource</code> object definition is passed as the first parameter to the <a href="../readablestream/readablestream"><code>ReadableStream()</code> constructor</a>. To make this a readable "byte" stream, we specify <code>type: "bytes"</code> as a property of the object. This ensures that the stream is handed a <a href="../readablebytestreamcontroller"><code>ReadableByteStreamController</code></a> (instead of the default controller (<a href="../readablestreamdefaultcontroller"><code>ReadableStreamDefaultController</code></a>)) </p> <p> Since data can arrive at the socket before the consumer is ready to handle it, everything about reading the underlying source is configured in the <code>start()</code> callback method (we don't wait on a pull to start handling data). The implementation opens the "socket" and calls <code>select2()</code> to request data. When the returned promise resolves the code checks if <code>controller.byobRequest</code> exists (is not <code>null</code>), and if so calls <code>socket.readInto()</code> to copy data into the request and transfer it. If <code>byobRequest</code> does not exist there is no outstanding request from a consuming stream that can be satisfied as a zero-copy transfer. In this case, <code>controller.enqueue()</code> used to copy data to the stream internal queues. </p> <p> The <code>select2()</code> request for more data is reposted until a request is returned with no data. A this point the controller is used to close the stream. </p> <div class="code-example"><pre data-language="js"><span class="token keyword">const</span> stream <span class="token operator">=</span> <span class="token function">makeSocketStream</span><span class="token punctuation">(</span><span class="token string">"dummy host"</span><span class="token punctuation">,</span> <span class="token string">"dummy port"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token keyword">const</span> <span class="token constant">DEFAULT_CHUNK_SIZE</span> <span class="token operator">=</span> <span class="token number">400</span><span class="token punctuation">;</span>

<span class="token keyword">function</span> <span class="token function">makeSocketStream</span><span class="token punctuation">(</span><span class="token parameter">host<span class="token punctuation">,</span> port</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token keyword">const</span> socket <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">MockHypotheticalSocket</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

  <span class="token keyword">return</span> <span class="token keyword">new</span> <span class="token class-name">ReadableStream</span><span class="token punctuation">(</span><span class="token punctuation">{</span>
    <span class="token literal-property property">type</span><span class="token operator">:</span> <span class="token string">"bytes"</span><span class="token punctuation">,</span>

    <span class="token function">start</span><span class="token punctuation">(</span><span class="token parameter">controller</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
      <span class="token function">readRepeatedly</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">catch</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token parameter">e</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> controller<span class="token punctuation">.</span><span class="token function">error</span><span class="token punctuation">(</span>e<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
      <span class="token keyword">function</span> <span class="token function">readRepeatedly</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">return</span> socket<span class="token punctuation">.</span><span class="token function">select2</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">then</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
          <span class="token comment">// Since the socket can become readable even when there's</span>
          <span class="token comment">// no pending BYOB requests, we need to handle both cases.</span>
          <span class="token keyword">let</span> bytesRead<span class="token punctuation">;</span>
          <span class="token keyword">if</span> <span class="token punctuation">(</span>controller<span class="token punctuation">.</span>byobRequest<span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token keyword">const</span> v <span class="token operator">=</span> controller<span class="token punctuation">.</span>byobRequest<span class="token punctuation">.</span>view<span class="token punctuation">;</span>
            bytesRead <span class="token operator">=</span> socket<span class="token punctuation">.</span><span class="token function">readInto</span><span class="token punctuation">(</span>v<span class="token punctuation">.</span>buffer<span class="token punctuation">,</span> v<span class="token punctuation">.</span>byteOffset<span class="token punctuation">,</span> v<span class="token punctuation">.</span>byteLength<span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token keyword">if</span> <span class="token punctuation">(</span>bytesRead <span class="token operator">===</span> <span class="token number">0</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
              controller<span class="token punctuation">.</span><span class="token function">close</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span>
            controller<span class="token punctuation">.</span>byobRequest<span class="token punctuation">.</span><span class="token function">respond</span><span class="token punctuation">(</span>bytesRead<span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token function">logSource</span><span class="token punctuation">(</span><span class="token template-string"><span class="token template-punctuation string">`</span><span class="token string">byobRequest with </span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">${</span>bytesRead<span class="token interpolation-punctuation punctuation">}</span></span><span class="token string"> bytes</span><span class="token template-punctuation string">`</span></span><span class="token punctuation">)</span><span class="token punctuation">;</span>
          <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>
            <span class="token keyword">const</span> buffer <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">ArrayBuffer</span><span class="token punctuation">(</span><span class="token constant">DEFAULT_CHUNK_SIZE</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            bytesRead <span class="token operator">=</span> socket<span class="token punctuation">.</span><span class="token function">readInto</span><span class="token punctuation">(</span>buffer<span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span> <span class="token constant">DEFAULT_CHUNK_SIZE</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token keyword">if</span> <span class="token punctuation">(</span>bytesRead <span class="token operator">===</span> <span class="token number">0</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
              controller<span class="token punctuation">.</span><span class="token function">close</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>
              controller<span class="token punctuation">.</span><span class="token function">enqueue</span><span class="token punctuation">(</span><span class="token keyword">new</span> <span class="token class-name">Uint8Array</span><span class="token punctuation">(</span>buffer<span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span> bytesRead<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span>
            <span class="token function">logSource</span><span class="token punctuation">(</span><span class="token template-string"><span class="token template-punctuation string">`</span><span class="token string">enqueue() </span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">${</span>bytesRead<span class="token interpolation-punctuation punctuation">}</span></span><span class="token string"> bytes (no byobRequest)</span><span class="token template-punctuation string">`</span></span><span class="token punctuation">)</span><span class="token punctuation">;</span>
          <span class="token punctuation">}</span>

          <span class="token keyword">if</span> <span class="token punctuation">(</span>bytesRead <span class="token operator">===</span> <span class="token number">0</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token keyword">return</span><span class="token punctuation">;</span>
            <span class="token comment">// no more bytes in source</span>
          <span class="token punctuation">}</span>
          <span class="token keyword">return</span> <span class="token function">readRepeatedly</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
      <span class="token punctuation">}</span>
    <span class="token punctuation">}</span><span class="token punctuation">,</span>

    <span class="token function">cancel</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
      socket<span class="token punctuation">.</span><span class="token function">close</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
      <span class="token function">logSource</span><span class="token punctuation">(</span><span class="token template-string"><span class="token template-punctuation string">`</span><span class="token string">cancel(): socket closed</span><span class="token template-punctuation string">`</span></span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span><span class="token punctuation">,</span>
  <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</pre></div> <p> Note that <code>readRepeatedly()</code> returns a promise, and we use this to catch any errors from setting up or handling the read operation. The errors are then passed to the controller as shown above (see <code>readRepeatedly().catch((e) =&gt; controller.error(e));</code>). </p> <p>A <code>cancel()</code> method is provided at the end to close the underlying source; the <code>pull()</code> callback is not needed, and is therefore not implemented.</p> <h4 id="consuming_the_push_byte_stream">Consuming the push byte stream</h4> <p> The following code creates a <code>ReadableStreamBYOBReader</code> for the socket byte stream and uses it read data into a buffer. Note <code>processText()</code> is called recursively to read more data until the buffer is filled. When the underlying source signals that it has no more data, the <code>reader.read()</code> will have <code>done</code> set to true, which in turn completes the read operation. </p> <p> This code is almost exactly the same as for the <a href="#underlying_pull_source_with_byte_reader">Underlying pull source with byte reader</a> example above. The only difference is that the reader includes some code to slow down reading, so the log output can demonstrate that data will be enqueued if not read fast enough. </p> <div class="code-example"><pre data-language="js"><span class="token keyword">const</span> reader <span class="token operator">=</span> stream<span class="token punctuation">.</span><span class="token function">getReader</span><span class="token punctuation">(</span><span class="token punctuation">{</span> <span class="token literal-property property">mode</span><span class="token operator">:</span> <span class="token string">"byob"</span> <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token keyword">let</span> buffer <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">ArrayBuffer</span><span class="token punctuation">(</span><span class="token number">4000</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token function">readStream</span><span class="token punctuation">(</span>reader<span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token keyword">function</span> <span class="token function">readStream</span><span class="token punctuation">(</span><span class="token parameter">reader</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token keyword">let</span> bytesReceived <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span>
  <span class="token keyword">let</span> offset <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span>

  <span class="token keyword">while</span> <span class="token punctuation">(</span>offset <span class="token operator">&lt;</span> buffer<span class="token punctuation">.</span>byteLength<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token comment">// read() returns a promise that resolves when a value has been received</span>
    reader
      <span class="token punctuation">.</span><span class="token function">read</span><span class="token punctuation">(</span><span class="token keyword">new</span> <span class="token class-name">Uint8Array</span><span class="token punctuation">(</span>buffer<span class="token punctuation">,</span> offset<span class="token punctuation">,</span> buffer<span class="token punctuation">.</span>byteLength <span class="token operator">-</span> offset<span class="token punctuation">)</span><span class="token punctuation">)</span>
      <span class="token punctuation">.</span><span class="token function">then</span><span class="token punctuation">(</span><span class="token keyword">async</span> <span class="token keyword">function</span> <span class="token function">processText</span><span class="token punctuation">(</span><span class="token parameter"><span class="token punctuation">{</span> done<span class="token punctuation">,</span> value <span class="token punctuation">}</span></span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token comment">// Result objects contain two properties:</span>
        <span class="token comment">// done  - true if the stream has already given all its data.</span>
        <span class="token comment">// value - some data. Always undefined when done is true.</span>

        <span class="token keyword">if</span> <span class="token punctuation">(</span>done<span class="token punctuation">)</span> <span class="token punctuation">{</span>
          <span class="token function">logConsumer</span><span class="token punctuation">(</span><span class="token template-string"><span class="token template-punctuation string">`</span><span class="token string">readStream() complete. Total bytes: </span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">${</span>bytesReceived<span class="token interpolation-punctuation punctuation">}</span></span><span class="token template-punctuation string">`</span></span><span class="token punctuation">)</span><span class="token punctuation">;</span>
          <span class="token keyword">return</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>

        buffer <span class="token operator">=</span> value<span class="token punctuation">.</span>buffer<span class="token punctuation">;</span>
        offset <span class="token operator">+=</span> value<span class="token punctuation">.</span>byteLength<span class="token punctuation">;</span>
        bytesReceived <span class="token operator">+=</span> value<span class="token punctuation">.</span>byteLength<span class="token punctuation">;</span>

        <span class="token comment">//logConsumer(`Read ${bytesReceived} bytes: ${value}`);</span>
        <span class="token function">logConsumer</span><span class="token punctuation">(</span><span class="token template-string"><span class="token template-punctuation string">`</span><span class="token string">Read </span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">${</span>bytesReceived<span class="token interpolation-punctuation punctuation">}</span></span><span class="token string"> bytes</span><span class="token template-punctuation string">`</span></span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        result <span class="token operator">+=</span> value<span class="token punctuation">;</span>

        <span class="token comment">// Add delay to emulate when data can't be read and data is enqueued</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>bytesReceived <span class="token operator">&gt;</span> <span class="token number">300</span> <span class="token operator">&amp;&amp;</span> bytesReceived <span class="token operator">&lt;</span> <span class="token number">600</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
          <span class="token function">logConsumer</span><span class="token punctuation">(</span><span class="token template-string"><span class="token template-punctuation string">`</span><span class="token string">Delaying read to emulate slow stream reading</span><span class="token template-punctuation string">`</span></span><span class="token punctuation">)</span><span class="token punctuation">;</span>
          <span class="token keyword">const</span> <span class="token function-variable function">delay</span> <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token parameter">ms</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span>
            <span class="token keyword">new</span> <span class="token class-name">Promise</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token parameter">resolve</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token function">setTimeout</span><span class="token punctuation">(</span>resolve<span class="token punctuation">,</span> ms<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
          <span class="token keyword">await</span> <span class="token function">delay</span><span class="token punctuation">(</span><span class="token number">1000</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>

        <span class="token comment">// Read some more, and call this function again</span>
        <span class="token keyword">return</span> reader
          <span class="token punctuation">.</span><span class="token function">read</span><span class="token punctuation">(</span><span class="token keyword">new</span> <span class="token class-name">Uint8Array</span><span class="token punctuation">(</span>buffer<span class="token punctuation">,</span> offset<span class="token punctuation">,</span> buffer<span class="token punctuation">.</span>byteLength <span class="token operator">-</span> offset<span class="token punctuation">)</span><span class="token punctuation">)</span>
          <span class="token punctuation">.</span><span class="token function">then</span><span class="token punctuation">(</span>processText<span class="token punctuation">)</span><span class="token punctuation">;</span>
      <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</pre></div> <h4 id="cancelling_the_stream_using_the_reader">Cancelling the stream using the reader</h4> <p> We can use <a href="../readablestreambyobreader/cancel"><code>ReadableStreamBYOBReader.cancel()</code></a> to cancel the stream. For this example we call the method if a button is clicked with a reason "user choice" (other HTML and code for the button not shown). We also log when the cancel operation completes. </p> <div class="code-example"><pre data-language="js">button<span class="token punctuation">.</span><span class="token function">addEventListener</span><span class="token punctuation">(</span><span class="token string">"click"</span><span class="token punctuation">,</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
  reader
    <span class="token punctuation">.</span><span class="token function">cancel</span><span class="token punctuation">(</span><span class="token string">"user choice"</span><span class="token punctuation">)</span>
    <span class="token punctuation">.</span><span class="token function">then</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token function">logConsumer</span><span class="token punctuation">(</span><span class="token string">"reader.cancel complete"</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
</pre></div> <p> <a href="../readablestreambyobreader/releaselock"><code>ReadableStreamBYOBReader.releaseLock()</code></a> can be used to release the reader without cancelling the stream. Note however that any outstanding read requests will immediately be rejected. A new reader can be acquired later on to read the remaining chunks. </p> <h4 id="monitoring_for_stream_for_closeerror">Monitoring for stream for close/error</h4> <p> The <a href="../readablestreambyobreader/closed"><code>ReadableStreamBYOBReader.closed</code></a> property returns a promise that will resolve when the stream is closed, and reject if there is an error. While no errors are expected in this case, the following code should log the completion case. </p> <div class="code-example"><pre data-language="js">reader<span class="token punctuation">.</span>closed
  <span class="token punctuation">.</span><span class="token function">then</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
    <span class="token function">logConsumer</span><span class="token punctuation">(</span><span class="token string">"ReadableStreamBYOBReader.closed: resolved"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span><span class="token punctuation">)</span>
  <span class="token punctuation">.</span><span class="token function">catch</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
    <span class="token function">logConsumer</span><span class="token punctuation">(</span><span class="token string">"ReadableStreamBYOBReader.closed: rejected:"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
</pre></div> <h4 id="result">Result</h4> <p> The logging from the underlying push source (left) and consumer (right) are shown below. Not the period in the middle where data is enqueued rather than transferred as a zero-copy operation. </p>
<iframe class="sample-code-frame" title="Underlying push source with byte reader" id="frame_underlying_push_source_with_default_reader" width="100%" height="500px" src="https://live-samples.mdn.mozilla.net/en-US/docs/Web/API/Streams_API/Using_readable_byte_streams/_sample_.underlying_push_source_with_default_reader.html" loading="lazy"></iframe>
</div>
<h3 id="underlying_pull_source_with_byte_reader">Underlying pull source with byte reader</h3>
<div class="section-content">
<p>This live example shows how data might be read from an "pull" underlying byte source, such as a file, and transferred by a stream as a zero-copy transfer to a <a href="../readablestreambyobreader"><code>ReadableStreamBYOBReader</code></a>.</p> <h4 id="mocked_underlying_file_source">Mocked underlying file source</h4> <p> For the underlying pull source we use the following class to (<em>very</em> superficially) mock a nodejs <a href="https://nodejs.org/api/fs.html#class-filehandle" target="_blank"><code>FileHandle</code></a>, and in particular the <a href="https://nodejs.org/api/fs.html#filehandlereadbuffer-offset-length-position" target="_blank"><code>read()</code></a> method. The class generates random data to represent a file. The <code>read()</code> method reads from this data into a provided buffer from the specified position. The <code>close()</code> method does nothing: it is only provided to show where you might close the source when defining the constructor for the stream. </p> <div class="notecard note" id="sect3"> <p> <strong>Note:</strong> This same class is used for all the "pull source" examples. It is shown here for information only (so that it is obvious that it is a mock). </p> </div> <div class="code-example"><pre data-language="js"><span class="token keyword">class</span> <span class="token class-name">MockUnderlyingFileHandle</span> <span class="token punctuation">{</span>
  <span class="token function">constructor</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">this</span><span class="token punctuation">.</span>maxdata <span class="token operator">=</span> <span class="token number">1300</span><span class="token punctuation">;</span> <span class="token comment">// "file size"</span>
    <span class="token keyword">this</span><span class="token punctuation">.</span>filedata <span class="token operator">=</span> <span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">randomByteArray</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">.</span>maxdata<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">this</span><span class="token punctuation">.</span>position <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>

  <span class="token comment">// Read data from "file" at position/length into specified buffer offset</span>
  <span class="token function">read</span><span class="token punctuation">(</span><span class="token parameter">buffer<span class="token punctuation">,</span> offset<span class="token punctuation">,</span> length<span class="token punctuation">,</span> position</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token comment">// Object used to resolve promise</span>
    <span class="token keyword">const</span> resultobj <span class="token operator">=</span> <span class="token punctuation">{</span><span class="token punctuation">}</span><span class="token punctuation">;</span>
    resultobj<span class="token punctuation">[</span><span class="token string">"buffer"</span><span class="token punctuation">]</span> <span class="token operator">=</span> buffer<span class="token punctuation">;</span>
    resultobj<span class="token punctuation">[</span><span class="token string">"bytesRead"</span><span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span>

    <span class="token keyword">return</span> <span class="token keyword">new</span> <span class="token class-name">Promise</span><span class="token punctuation">(</span><span class="token punctuation">(</span>resolve <span class="token comment">/*, reject*/</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
      <span class="token keyword">if</span> <span class="token punctuation">(</span>position <span class="token operator">&gt;=</span> <span class="token keyword">this</span><span class="token punctuation">.</span>maxdata<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token comment">//out of data</span>
        <span class="token function">resolve</span><span class="token punctuation">(</span>resultobj<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">return</span><span class="token punctuation">;</span>
      <span class="token punctuation">}</span>

      <span class="token comment">// Read random data into supplied buffer</span>
      <span class="token keyword">const</span> myview <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Uint8Array</span><span class="token punctuation">(</span>buffer<span class="token punctuation">,</span> offset<span class="token punctuation">,</span> length<span class="token punctuation">)</span><span class="token punctuation">;</span>
      <span class="token comment">// Write the length of data specified</span>
      <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token keyword">let</span> i <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span> i <span class="token operator">&lt;</span> length<span class="token punctuation">;</span> i<span class="token operator">++</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        myview<span class="token punctuation">[</span>i<span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token keyword">this</span><span class="token punctuation">.</span>filedata<span class="token punctuation">[</span>position <span class="token operator">+</span> i<span class="token punctuation">]</span><span class="token punctuation">;</span>
        resultobj<span class="token punctuation">[</span><span class="token string">"bytesRead"</span><span class="token punctuation">]</span> <span class="token operator">=</span> i<span class="token punctuation">;</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>position <span class="token operator">+</span> i <span class="token operator">&gt;=</span> <span class="token keyword">this</span><span class="token punctuation">.</span>maxdata<span class="token punctuation">)</span> <span class="token punctuation">{</span>
          <span class="token keyword">break</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
      <span class="token punctuation">}</span>
      <span class="token comment">// Emulate slow read of data</span>
      <span class="token function">setTimeout</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
        <span class="token function">resolve</span><span class="token punctuation">(</span>resultobj<span class="token punctuation">)</span><span class="token punctuation">;</span>
      <span class="token punctuation">}</span><span class="token punctuation">,</span> <span class="token number">1000</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>

  <span class="token comment">// Dummy close function</span>
  <span class="token function">close</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">return</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>

  <span class="token comment">// Return random character string</span>
  <span class="token function">randomChars</span><span class="token punctuation">(</span><span class="token parameter">length <span class="token operator">=</span> <span class="token number">8</span></span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">let</span> string <span class="token operator">=</span> <span class="token string">""</span><span class="token punctuation">;</span>
    <span class="token keyword">let</span> choices <span class="token operator">=</span>
      <span class="token string">"ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz0123456789!@#$%^&amp;*()"</span><span class="token punctuation">;</span>

    <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token keyword">let</span> i <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span> i <span class="token operator">&lt;</span> length<span class="token punctuation">;</span> i<span class="token operator">++</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
      string <span class="token operator">+=</span> choices<span class="token punctuation">.</span><span class="token function">charAt</span><span class="token punctuation">(</span>Math<span class="token punctuation">.</span><span class="token function">floor</span><span class="token punctuation">(</span>Math<span class="token punctuation">.</span><span class="token function">random</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">*</span> choices<span class="token punctuation">.</span>length<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
    <span class="token keyword">return</span> string<span class="token punctuation">;</span>
  <span class="token punctuation">}</span>

  <span class="token comment">// Return random Uint8Array of bytes</span>
  <span class="token function">randomByteArray</span><span class="token punctuation">(</span><span class="token parameter">bytes <span class="token operator">=</span> <span class="token number">8</span></span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">const</span> textEncoder <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">TextEncoder</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">return</span> textEncoder<span class="token punctuation">.</span><span class="token function">encode</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">randomChars</span><span class="token punctuation">(</span>bytes<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</pre></div>    <h4 id="creating_a_readable_file_byte_stream">Creating a readable file byte stream</h4> <p>The following code shows how to define a readable file byte stream.</p> <p> Just as for the previous example, the <code>underlyingSource</code> object definition is passed as the first parameter to the <a href="../readablestream/readablestream"><code>ReadableStream()</code> constructor</a>. To make this a readable "byte" stream, we specify <code>type: "bytes"</code> as a property of the object. This ensures that the stream is handed a <a href="../readablebytestreamcontroller"><code>ReadableByteStreamController</code></a>. </p> <p> The <code>start()</code> function simply opens the file handle, which is then closed in the <code>cancel()</code> callback. <code>cancel()</code> is provided to clean up any resources if <a href="../readablestream/cancel"><code>ReadableStream.cancel()</code></a> or <a href="../readablestreamdefaultcontroller/close"><code>ReadableStreamDefaultController.close()</code></a> are called. </p> <p> Most of the interesting code is in the <code>pull()</code> callback. This copies data from the file into the pending read request (<a href="../readablebytestreamcontroller/byobrequest"><code>ReadableByteStreamController.byobRequest</code></a>) and then calls <a href="../readablestreambyobrequest/respond"><code>respond()</code></a> to indicate how much data is in the buffer and transfer it. If 0 bytes were transferred from the file then we know it has all been copied, and call <a href="../readablestreamdefaultcontroller/close"><code>close()</code></a> on the controller, which in turn will result in <code>cancel()</code> being called on the underlying source. </p> <div class="code-example"><pre data-language="js"><span class="token keyword">const</span> stream <span class="token operator">=</span> <span class="token function">makeReadableByteFileStream</span><span class="token punctuation">(</span><span class="token string">"dummy file.txt"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token keyword">function</span> <span class="token function">makeReadableByteFileStream</span><span class="token punctuation">(</span><span class="token parameter">filename</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token keyword">let</span> fileHandle<span class="token punctuation">;</span>
  <span class="token keyword">let</span> position <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span>
  <span class="token keyword">return</span> <span class="token keyword">new</span> <span class="token class-name">ReadableStream</span><span class="token punctuation">(</span><span class="token punctuation">{</span>
    <span class="token literal-property property">type</span><span class="token operator">:</span> <span class="token string">"bytes"</span><span class="token punctuation">,</span> <span class="token comment">// An underlying byte stream!</span>
    <span class="token function">start</span><span class="token punctuation">(</span><span class="token parameter">controller</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
      <span class="token comment">// Called to initialise the underlying source.</span>
      <span class="token comment">// For a file source open a file handle (here we just create the mocked object).</span>
      fileHandle <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">MockUnderlyingFileHandle</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
      <span class="token function">logSource</span><span class="token punctuation">(</span>
        <span class="token template-string"><span class="token template-punctuation string">`</span><span class="token string">start(): </span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">${</span>controller<span class="token punctuation">.</span>constructor<span class="token punctuation">.</span>name<span class="token interpolation-punctuation punctuation">}</span></span><span class="token string">.byobRequest = </span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">${</span>controller<span class="token punctuation">.</span>byobRequest<span class="token interpolation-punctuation punctuation">}</span></span><span class="token template-punctuation string">`</span></span>
      <span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span><span class="token punctuation">,</span>
    <span class="token keyword">async</span> <span class="token function">pull</span><span class="token punctuation">(</span><span class="token parameter">controller</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
      <span class="token comment">// Called when there is a pull request for data</span>
      <span class="token keyword">const</span> theView <span class="token operator">=</span> controller<span class="token punctuation">.</span>byobRequest<span class="token punctuation">.</span>view<span class="token punctuation">;</span>
      <span class="token keyword">const</span> <span class="token punctuation">{</span> bytesRead<span class="token punctuation">,</span> buffer <span class="token punctuation">}</span> <span class="token operator">=</span> <span class="token keyword">await</span> fileHandle<span class="token punctuation">.</span><span class="token function">read</span><span class="token punctuation">(</span>
        theView<span class="token punctuation">.</span>buffer<span class="token punctuation">,</span>
        theView<span class="token punctuation">.</span>offset<span class="token punctuation">,</span>
        theView<span class="token punctuation">.</span>length<span class="token punctuation">,</span>
        position
      <span class="token punctuation">)</span><span class="token punctuation">;</span>
      <span class="token keyword">if</span> <span class="token punctuation">(</span>bytesRead <span class="token operator">===</span> <span class="token number">0</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">await</span> fileHandle<span class="token punctuation">.</span><span class="token function">close</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        controller<span class="token punctuation">.</span><span class="token function">close</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        controller<span class="token punctuation">.</span>byobRequest<span class="token punctuation">.</span><span class="token function">respond</span><span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token function">logSource</span><span class="token punctuation">(</span>
          <span class="token template-string"><span class="token template-punctuation string">`</span><span class="token string">pull() with byobRequest. Close controller (read bytes: </span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">${</span>bytesRead<span class="token interpolation-punctuation punctuation">}</span></span><span class="token string">)</span><span class="token template-punctuation string">`</span></span>
        <span class="token punctuation">)</span><span class="token punctuation">;</span>
      <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>
        position <span class="token operator">+=</span> bytesRead<span class="token punctuation">;</span>
        controller<span class="token punctuation">.</span>byobRequest<span class="token punctuation">.</span><span class="token function">respond</span><span class="token punctuation">(</span>bytesRead<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token function">logSource</span><span class="token punctuation">(</span><span class="token template-string"><span class="token template-punctuation string">`</span><span class="token string">pull() with byobRequest. Transfer </span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">${</span>bytesRead<span class="token interpolation-punctuation punctuation">}</span></span><span class="token string"> bytes</span><span class="token template-punctuation string">`</span></span><span class="token punctuation">)</span><span class="token punctuation">;</span>
      <span class="token punctuation">}</span>
    <span class="token punctuation">}</span><span class="token punctuation">,</span>
    <span class="token function">cancel</span><span class="token punctuation">(</span><span class="token parameter">reason</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
      <span class="token comment">// This is called if the stream is cancelled (via reader or controller).</span>
      <span class="token comment">// Clean up any resources</span>
      fileHandle<span class="token punctuation">.</span><span class="token function">close</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
      <span class="token function">logSource</span><span class="token punctuation">(</span><span class="token template-string"><span class="token template-punctuation string">`</span><span class="token string">cancel() with reason: </span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">${</span>reason<span class="token interpolation-punctuation punctuation">}</span></span><span class="token template-punctuation string">`</span></span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span><span class="token punctuation">,</span>
  <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</pre></div> <h4 id="consuming_the_byte_stream">Consuming the byte stream</h4> <p> The following code creates a <code>ReadableStreamBYOBReader</code> for the file byte stream and uses it read data into a buffer. Note <code>processText()</code> is called recursively to read more data until the buffer is filled. When the underlying source signals that it has no more data, the <code>reader.read()</code> will have <code>done</code> set to true, which in turn completes the read operation. </p> <div class="code-example"><pre data-language="js"><span class="token keyword">const</span> reader <span class="token operator">=</span> stream<span class="token punctuation">.</span><span class="token function">getReader</span><span class="token punctuation">(</span><span class="token punctuation">{</span> <span class="token literal-property property">mode</span><span class="token operator">:</span> <span class="token string">"byob"</span> <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token keyword">let</span> buffer <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">ArrayBuffer</span><span class="token punctuation">(</span><span class="token number">4000</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token function">readStream</span><span class="token punctuation">(</span>reader<span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token keyword">function</span> <span class="token function">readStream</span><span class="token punctuation">(</span><span class="token parameter">reader</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token keyword">let</span> bytesReceived <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span>
  <span class="token keyword">let</span> offset <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span>

  <span class="token keyword">while</span> <span class="token punctuation">(</span>offset <span class="token operator">&lt;</span> buffer<span class="token punctuation">.</span>byteLength<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token comment">// read() returns a promise that resolves when a value has been received</span>
    reader
      <span class="token punctuation">.</span><span class="token function">read</span><span class="token punctuation">(</span><span class="token keyword">new</span> <span class="token class-name">Uint8Array</span><span class="token punctuation">(</span>buffer<span class="token punctuation">,</span> offset<span class="token punctuation">,</span> buffer<span class="token punctuation">.</span>byteLength <span class="token operator">-</span> offset<span class="token punctuation">)</span><span class="token punctuation">)</span>
      <span class="token punctuation">.</span><span class="token function">then</span><span class="token punctuation">(</span><span class="token keyword">function</span> <span class="token function">processText</span><span class="token punctuation">(</span><span class="token parameter"><span class="token punctuation">{</span> done<span class="token punctuation">,</span> value <span class="token punctuation">}</span></span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token comment">// Result objects contain two properties:</span>
        <span class="token comment">// done  - true if the stream has already given all its data.</span>
        <span class="token comment">// value - some data. Always undefined when done is true.</span>

        <span class="token keyword">if</span> <span class="token punctuation">(</span>done<span class="token punctuation">)</span> <span class="token punctuation">{</span>
          <span class="token function">logConsumer</span><span class="token punctuation">(</span><span class="token template-string"><span class="token template-punctuation string">`</span><span class="token string">readStream() complete. Total bytes: </span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">${</span>bytesReceived<span class="token interpolation-punctuation punctuation">}</span></span><span class="token template-punctuation string">`</span></span><span class="token punctuation">)</span><span class="token punctuation">;</span>
          <span class="token keyword">return</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>

        buffer <span class="token operator">=</span> value<span class="token punctuation">.</span>buffer<span class="token punctuation">;</span>
        offset <span class="token operator">+=</span> value<span class="token punctuation">.</span>byteLength<span class="token punctuation">;</span>
        bytesReceived <span class="token operator">+=</span> value<span class="token punctuation">.</span>byteLength<span class="token punctuation">;</span>

        <span class="token function">logConsumer</span><span class="token punctuation">(</span><span class="token template-string"><span class="token template-punctuation string">`</span><span class="token string">Read </span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">${</span>bytesReceived<span class="token interpolation-punctuation punctuation">}</span></span><span class="token string"> bytes: </span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">${</span>value<span class="token interpolation-punctuation punctuation">}</span></span><span class="token template-punctuation string">`</span></span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        result <span class="token operator">+=</span> value<span class="token punctuation">;</span>

        <span class="token comment">// Read some more, and call this function again</span>
        <span class="token keyword">return</span> reader
          <span class="token punctuation">.</span><span class="token function">read</span><span class="token punctuation">(</span><span class="token keyword">new</span> <span class="token class-name">Uint8Array</span><span class="token punctuation">(</span>buffer<span class="token punctuation">,</span> offset<span class="token punctuation">,</span> buffer<span class="token punctuation">.</span>byteLength <span class="token operator">-</span> offset<span class="token punctuation">)</span><span class="token punctuation">)</span>
          <span class="token punctuation">.</span><span class="token function">then</span><span class="token punctuation">(</span>processText<span class="token punctuation">)</span><span class="token punctuation">;</span>
      <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</pre></div> <p>Lastly, we add a handler that will cancel the stream if a button is clicked (other HTML and code for the button not shown).</p> <div class="code-example"><pre data-language="js">button<span class="token punctuation">.</span><span class="token function">addEventListener</span><span class="token punctuation">(</span><span class="token string">"click"</span><span class="token punctuation">,</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
  reader<span class="token punctuation">.</span><span class="token function">cancel</span><span class="token punctuation">(</span><span class="token string">"user choice"</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">then</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
    <span class="token function">logConsumer</span><span class="token punctuation">(</span><span class="token template-string"><span class="token template-punctuation string">`</span><span class="token string">reader.cancel complete</span><span class="token template-punctuation string">`</span></span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
</pre></div> <h4 id="result_2">Result</h4> <p> The logging from the underlying pull source (left) and consumer (right) are shown below. Of particular note are that the: </p> <ul> <li>
<code>start()</code> function is passed a <code>ReadableByteStreamController</code>
</li> <li>the buffer passed to the reader is large enough to encompass the whole "file", so the whole file is transferred in one operation.</li> </ul>
<iframe class="sample-code-frame" title="Underlying pull source with byte reader" id="frame_underlying_pull_source" width="100%" height="500px" src="https://live-samples.mdn.mozilla.net/en-US/docs/Web/API/Streams_API/Using_readable_byte_streams/_sample_.underlying_pull_source.html" loading="lazy"></iframe>
</div>
<h3 id="underlying_pull_source_with_default_reader">Underlying pull source with default reader</h3>
<div class="section-content">
<p> This live example shows how the same data might be read as a zero-copy transfer using a default reader (<a href="../readablestreamdefaultreader"><code>ReadableStreamDefaultReader</code></a>). This uses the same <a href="#mocked_underlying_file_source">mocked underlying file source</a> as in the preceding example. </p>     <h4 id="creating_a_readable_file_byte_stream_with_automatic_buffer_allocation">Creating a readable file byte stream with automatic buffer allocation</h4> <p>The only difference in our underlying source is that we must specify <code>autoAllocateChunkSize</code>, and that the size will be used as the view buffer size for <code>controller.byobRequest</code>, rather than one supplied by the consumer.</p> <div class="code-example"><pre data-language="js"><span class="token keyword">const</span> <span class="token constant">DEFAULT_CHUNK_SIZE</span> <span class="token operator">=</span> <span class="token number">200</span><span class="token punctuation">;</span>
<span class="token keyword">const</span> stream <span class="token operator">=</span> <span class="token function">makeReadableByteFileStream</span><span class="token punctuation">(</span><span class="token string">"dummy file.txt"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token keyword">function</span> <span class="token function">makeReadableByteFileStream</span><span class="token punctuation">(</span><span class="token parameter">filename</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token keyword">let</span> fileHandle<span class="token punctuation">;</span>
  <span class="token keyword">let</span> position <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span>
  <span class="token keyword">return</span> <span class="token keyword">new</span> <span class="token class-name">ReadableStream</span><span class="token punctuation">(</span><span class="token punctuation">{</span>
    <span class="token literal-property property">type</span><span class="token operator">:</span> <span class="token string">"bytes"</span><span class="token punctuation">,</span> <span class="token comment">// An underlying byte stream!</span>
    <span class="token function">start</span><span class="token punctuation">(</span><span class="token parameter">controller</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
      <span class="token comment">// Called to initialise the underlying source.</span>
      <span class="token comment">// For a file source open a file handle (here we just create the mocked object).</span>
      fileHandle <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">MockUnderlyingFileHandle</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
      <span class="token function">logSource</span><span class="token punctuation">(</span>
        <span class="token template-string"><span class="token template-punctuation string">`</span><span class="token string">start(): </span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">${</span>controller<span class="token punctuation">.</span>constructor<span class="token punctuation">.</span>name<span class="token interpolation-punctuation punctuation">}</span></span><span class="token string">.byobRequest = </span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">${</span>controller<span class="token punctuation">.</span>byobRequest<span class="token interpolation-punctuation punctuation">}</span></span><span class="token template-punctuation string">`</span></span>
      <span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span><span class="token punctuation">,</span>
    <span class="token keyword">async</span> <span class="token function">pull</span><span class="token punctuation">(</span><span class="token parameter">controller</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
      <span class="token comment">// Called when there is a pull request for data</span>
      <span class="token keyword">const</span> theView <span class="token operator">=</span> controller<span class="token punctuation">.</span>byobRequest<span class="token punctuation">.</span>view<span class="token punctuation">;</span>
      <span class="token keyword">const</span> <span class="token punctuation">{</span> bytesRead<span class="token punctuation">,</span> buffer <span class="token punctuation">}</span> <span class="token operator">=</span> <span class="token keyword">await</span> fileHandle<span class="token punctuation">.</span><span class="token function">read</span><span class="token punctuation">(</span>
        theView<span class="token punctuation">.</span>buffer<span class="token punctuation">,</span>
        theView<span class="token punctuation">.</span>offset<span class="token punctuation">,</span>
        theView<span class="token punctuation">.</span>length<span class="token punctuation">,</span>
        position
      <span class="token punctuation">)</span><span class="token punctuation">;</span>
      <span class="token keyword">if</span> <span class="token punctuation">(</span>bytesRead <span class="token operator">===</span> <span class="token number">0</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">await</span> fileHandle<span class="token punctuation">.</span><span class="token function">close</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        controller<span class="token punctuation">.</span><span class="token function">close</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        controller<span class="token punctuation">.</span>byobRequest<span class="token punctuation">.</span><span class="token function">respond</span><span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token function">logSource</span><span class="token punctuation">(</span>
          <span class="token template-string"><span class="token template-punctuation string">`</span><span class="token string">pull() with byobRequest. Close controller (read bytes: </span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">${</span>bytesRead<span class="token interpolation-punctuation punctuation">}</span></span><span class="token string">)</span><span class="token template-punctuation string">`</span></span>
        <span class="token punctuation">)</span><span class="token punctuation">;</span>
      <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>
        position <span class="token operator">+=</span> bytesRead<span class="token punctuation">;</span>
        controller<span class="token punctuation">.</span>byobRequest<span class="token punctuation">.</span><span class="token function">respond</span><span class="token punctuation">(</span>bytesRead<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token function">logSource</span><span class="token punctuation">(</span><span class="token template-string"><span class="token template-punctuation string">`</span><span class="token string">pull() with byobRequest. Transfer </span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">${</span>bytesRead<span class="token interpolation-punctuation punctuation">}</span></span><span class="token string"> bytes</span><span class="token template-punctuation string">`</span></span><span class="token punctuation">)</span><span class="token punctuation">;</span>
      <span class="token punctuation">}</span>
    <span class="token punctuation">}</span><span class="token punctuation">,</span>
    <span class="token function">cancel</span><span class="token punctuation">(</span><span class="token parameter">reason</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
      <span class="token comment">// This is called if the stream is cancelled (via reader or controller).</span>
      <span class="token comment">// Clean up any resources</span>
      fileHandle<span class="token punctuation">.</span><span class="token function">close</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
      <span class="token function">logSource</span><span class="token punctuation">(</span><span class="token template-string"><span class="token template-punctuation string">`</span><span class="token string">cancel() with reason: </span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">${</span>reason<span class="token interpolation-punctuation punctuation">}</span></span><span class="token template-punctuation string">`</span></span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span><span class="token punctuation">,</span>
    <span class="token literal-property property">autoAllocateChunkSize</span><span class="token operator">:</span> <span class="token constant">DEFAULT_CHUNK_SIZE</span><span class="token punctuation">,</span> <span class="token comment">// Only relevant if using a default reader</span>
  <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</pre></div> <h4 id="consuming_the_byte_stream_with_default_reader">Consuming the byte stream with default reader</h4> <p> The following code creates a <a href="../readablestreamdefaultreader"><code>ReadableStreamDefaultReader</code></a> for the file byte stream by calling <code>stream.getReader();</code> without specifying the mode, and uses it read data into a buffer. The operation of the code is the same as the previous example except that the buffer is supplied by the stream rather than the consumer. </p> <div class="code-example"><pre data-language="js"><span class="token keyword">const</span> reader <span class="token operator">=</span> stream<span class="token punctuation">.</span><span class="token function">getReader</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token function">readStream</span><span class="token punctuation">(</span>reader<span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token keyword">function</span> <span class="token function">readStream</span><span class="token punctuation">(</span><span class="token parameter">reader</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token keyword">let</span> bytesReceived <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span>
  <span class="token keyword">let</span> result <span class="token operator">=</span> <span class="token string">""</span><span class="token punctuation">;</span>

  <span class="token comment">// read() returns a promise that resolves</span>
  <span class="token comment">// when a value has been received</span>
  reader<span class="token punctuation">.</span><span class="token function">read</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">then</span><span class="token punctuation">(</span><span class="token keyword">function</span> <span class="token function">processText</span><span class="token punctuation">(</span><span class="token parameter"><span class="token punctuation">{</span> done<span class="token punctuation">,</span> value <span class="token punctuation">}</span></span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token comment">// Result objects contain two properties:</span>
    <span class="token comment">// done  - true if the stream has already given you all its data.</span>
    <span class="token comment">// value - some data. Always undefined when done is true.</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>done<span class="token punctuation">)</span> <span class="token punctuation">{</span>
      <span class="token function">logConsumer</span><span class="token punctuation">(</span><span class="token template-string"><span class="token template-punctuation string">`</span><span class="token string">readStream() complete. Total bytes: </span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">${</span>bytesReceived<span class="token interpolation-punctuation punctuation">}</span></span><span class="token template-punctuation string">`</span></span><span class="token punctuation">)</span><span class="token punctuation">;</span>
      <span class="token keyword">return</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    bytesReceived <span class="token operator">+=</span> value<span class="token punctuation">.</span>length<span class="token punctuation">;</span>
    <span class="token function">logConsumer</span><span class="token punctuation">(</span><span class="token template-string"><span class="token template-punctuation string">`</span><span class="token string">Read </span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">${</span>bytesReceived<span class="token interpolation-punctuation punctuation">}</span></span><span class="token string"> bytes so far. Current bytes = </span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">${</span>value<span class="token interpolation-punctuation punctuation">}</span></span><span class="token template-punctuation string">`</span></span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    result <span class="token operator">+=</span> value<span class="token punctuation">;</span>

    <span class="token comment">// Read some more, and call this function again</span>
    <span class="token keyword">return</span> reader<span class="token punctuation">.</span><span class="token function">read</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">then</span><span class="token punctuation">(</span>processText<span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</pre></div> <p>Lastly, we add a handler that will cancel the stream if a button is clicked (other HTML and code for the button not shown).</p> <div class="code-example"><pre data-language="js">button<span class="token punctuation">.</span><span class="token function">addEventListener</span><span class="token punctuation">(</span><span class="token string">"click"</span><span class="token punctuation">,</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
  reader<span class="token punctuation">.</span><span class="token function">cancel</span><span class="token punctuation">(</span><span class="token string">"user choice"</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">then</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
    <span class="token function">logConsumer</span><span class="token punctuation">(</span><span class="token template-string"><span class="token template-punctuation string">`</span><span class="token string">reader.cancel complete</span><span class="token template-punctuation string">`</span></span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
</pre></div> <h4 id="result_3">Result</h4> <p>The logging from the underlying bye pull source (left) and consumer (right) are shown below.</p> <p> Note that the chunks are now 200-byte wide, as specified in the underlying byte source. These are made as zero-copy transfers. </p>
<iframe class="sample-code-frame" title="Underlying pull source with default reader sample" id="frame_underlying_pull_source_with_default_reader" width="100%" height="500px" src="https://live-samples.mdn.mozilla.net/en-US/docs/Web/API/Streams_API/Using_readable_byte_streams/_sample_.underlying_pull_source_with_default_reader.html" loading="lazy"></iframe>
</div>
<h3 id="underlying_pull_source_with_default_reader_and_no_allocation">Underlying pull source with default reader and no allocation</h3>
<div class="section-content">
<p>For completeness, we can also use a default reader with a byte source that does not support automatic buffer allocation.</p>     <p> However in this case the controller will not supply a <code>byobRequest</code> for the underlying source to write into. Instead the underlying source would have to enqueue the data. Note below that to support this case, in <code>pull()</code> we need to check if the <code>byobRequest</code> exists. </p> <div class="code-example"><pre data-language="js"><span class="token keyword">const</span> stream <span class="token operator">=</span> <span class="token function">makeReadableByteFileStream</span><span class="token punctuation">(</span><span class="token string">"dummy file.txt"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token keyword">const</span> <span class="token constant">DEFAULT_CHUNK_SIZE</span> <span class="token operator">=</span> <span class="token number">300</span><span class="token punctuation">;</span>

<span class="token keyword">function</span> <span class="token function">makeReadableByteFileStream</span><span class="token punctuation">(</span><span class="token parameter">filename</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token keyword">let</span> fileHandle<span class="token punctuation">;</span>
  <span class="token keyword">let</span> position <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span>
  <span class="token keyword">return</span> <span class="token keyword">new</span> <span class="token class-name">ReadableStream</span><span class="token punctuation">(</span><span class="token punctuation">{</span>
    <span class="token literal-property property">type</span><span class="token operator">:</span> <span class="token string">"bytes"</span><span class="token punctuation">,</span> <span class="token comment">// An underlying byte stream!</span>
    <span class="token function">start</span><span class="token punctuation">(</span><span class="token parameter">controller</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
      <span class="token comment">// Called to initialise the underlying source.</span>
      <span class="token comment">// For a file source open a file handle (here we just create the mocked object).</span>
      fileHandle <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">MockUnderlyingFileHandle</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
      <span class="token function">logSource</span><span class="token punctuation">(</span>
        <span class="token template-string"><span class="token template-punctuation string">`</span><span class="token string">start(): </span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">${</span>controller<span class="token punctuation">.</span>constructor<span class="token punctuation">.</span>name<span class="token interpolation-punctuation punctuation">}</span></span><span class="token string">.byobRequest = </span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">${</span>controller<span class="token punctuation">.</span>byobRequest<span class="token interpolation-punctuation punctuation">}</span></span><span class="token template-punctuation string">`</span></span>
      <span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span><span class="token punctuation">,</span>
    <span class="token keyword">async</span> <span class="token function">pull</span><span class="token punctuation">(</span><span class="token parameter">controller</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
      <span class="token comment">// Called when there is a pull request for data</span>
      <span class="token keyword">if</span> <span class="token punctuation">(</span>controller<span class="token punctuation">.</span>byobRequest<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">const</span> theView <span class="token operator">=</span> controller<span class="token punctuation">.</span>byobRequest<span class="token punctuation">.</span>view<span class="token punctuation">;</span>
        <span class="token keyword">const</span> <span class="token punctuation">{</span> bytesRead<span class="token punctuation">,</span> buffer <span class="token punctuation">}</span> <span class="token operator">=</span> <span class="token keyword">await</span> fileHandle<span class="token punctuation">.</span><span class="token function">read</span><span class="token punctuation">(</span>
          theView<span class="token punctuation">.</span>buffer<span class="token punctuation">,</span>
          theView<span class="token punctuation">.</span>offset<span class="token punctuation">,</span>
          theView<span class="token punctuation">.</span>length<span class="token punctuation">,</span>
          position
        <span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>bytesRead <span class="token operator">===</span> <span class="token number">0</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
          <span class="token keyword">await</span> fileHandle<span class="token punctuation">.</span><span class="token function">close</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
          controller<span class="token punctuation">.</span><span class="token function">close</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
          controller<span class="token punctuation">.</span>byobRequest<span class="token punctuation">.</span><span class="token function">respond</span><span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
          <span class="token function">logSource</span><span class="token punctuation">(</span>
            <span class="token template-string"><span class="token template-punctuation string">`</span><span class="token string">pull() with byobRequest. Close controller (read bytes: </span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">${</span>bytesRead<span class="token interpolation-punctuation punctuation">}</span></span><span class="token string">)</span><span class="token template-punctuation string">`</span></span>
          <span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>
          position <span class="token operator">+=</span> bytesRead<span class="token punctuation">;</span>
          controller<span class="token punctuation">.</span>byobRequest<span class="token punctuation">.</span><span class="token function">respond</span><span class="token punctuation">(</span>bytesRead<span class="token punctuation">)</span><span class="token punctuation">;</span>
          <span class="token function">logSource</span><span class="token punctuation">(</span><span class="token template-string"><span class="token template-punctuation string">`</span><span class="token string">pull() with byobRequest. Transfer </span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">${</span>bytesRead<span class="token interpolation-punctuation punctuation">}</span></span><span class="token string"> bytes</span><span class="token template-punctuation string">`</span></span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
      <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>
        <span class="token comment">// No BYOBRequest so enqueue data to stream</span>
        <span class="token comment">// NOTE, this branch would only execute for a default reader if autoAllocateChunkSize is not defined.</span>
        <span class="token keyword">const</span> mynewBuffer <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Uint8Array</span><span class="token punctuation">(</span><span class="token constant">DEFAULT_CHUNK_SIZE</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">const</span> <span class="token punctuation">{</span> bytesRead<span class="token punctuation">,</span> buffer <span class="token punctuation">}</span> <span class="token operator">=</span> <span class="token keyword">await</span> fileHandle<span class="token punctuation">.</span><span class="token function">read</span><span class="token punctuation">(</span>
          mynewBuffer<span class="token punctuation">.</span>buffer<span class="token punctuation">,</span>
          mynewBuffer<span class="token punctuation">.</span>offset<span class="token punctuation">,</span>
          mynewBuffer<span class="token punctuation">.</span>length<span class="token punctuation">,</span>
          position
        <span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>bytesRead <span class="token operator">===</span> <span class="token number">0</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
          <span class="token keyword">await</span> fileHandle<span class="token punctuation">.</span><span class="token function">close</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
          controller<span class="token punctuation">.</span><span class="token function">close</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
          controller<span class="token punctuation">.</span><span class="token function">enqueue</span><span class="token punctuation">(</span>mynewBuffer<span class="token punctuation">)</span><span class="token punctuation">;</span>
          <span class="token function">logSource</span><span class="token punctuation">(</span>
            <span class="token template-string"><span class="token template-punctuation string">`</span><span class="token string">pull() with no byobRequest. Close controller (read bytes: </span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">${</span>bytesRead<span class="token interpolation-punctuation punctuation">}</span></span><span class="token string">)</span><span class="token template-punctuation string">`</span></span>
          <span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>
          position <span class="token operator">+=</span> bytesRead<span class="token punctuation">;</span>
          controller<span class="token punctuation">.</span><span class="token function">enqueue</span><span class="token punctuation">(</span>mynewBuffer<span class="token punctuation">)</span><span class="token punctuation">;</span>
          <span class="token function">logSource</span><span class="token punctuation">(</span><span class="token template-string"><span class="token template-punctuation string">`</span><span class="token string">pull() with no byobRequest. enqueue() </span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">${</span>bytesRead<span class="token interpolation-punctuation punctuation">}</span></span><span class="token string"> bytes</span><span class="token template-punctuation string">`</span></span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
      <span class="token punctuation">}</span>
    <span class="token punctuation">}</span><span class="token punctuation">,</span>
    <span class="token function">cancel</span><span class="token punctuation">(</span><span class="token parameter">reason</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
      <span class="token comment">// This is called if the stream is cancelled (via reader or controller).</span>
      <span class="token comment">// Clean up any resources</span>
      fileHandle<span class="token punctuation">.</span><span class="token function">close</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
      <span class="token function">logSource</span><span class="token punctuation">(</span><span class="token template-string"><span class="token template-punctuation string">`</span><span class="token string">cancel() with reason: </span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">${</span>reason<span class="token interpolation-punctuation punctuation">}</span></span><span class="token template-punctuation string">`</span></span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span><span class="token punctuation">,</span>
  <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</pre></div>   <h4 id="result_4">Result</h4> <p> The logging from the underlying pull source (left) and consumer (right) are shown below. Note that the underlying source side shows that the data has been enqueued rather than zero-byte transferred. </p>
<iframe class="sample-code-frame" title="Underlying pull source with default reader and no allocation sample" id="frame_underlying_pull_source_with_default_reader_and_no_allocation" width="100%" height="500px" src="https://live-samples.mdn.mozilla.net/en-US/docs/Web/API/Streams_API/Using_readable_byte_streams/_sample_.underlying_pull_source_with_default_reader_and_no_allocation.html" loading="lazy"></iframe>
</div>
<h2 id="see_also">See also</h2>
<div class="section-content"><ul> <li><a href="concepts">Streams API concepts</a></li> <li><a href="../streams_api#concepts_and_usage">Streams concepts and usage overview</a></li> <li><a href="using_readable_streams">Using readable streams</a></li> </ul></div>
<div class="_attribution">
  <p class="_attribution-p">
    © 2005–2023 MDN contributors.<br>Licensed under the Creative Commons Attribution-ShareAlike License v2.5 or later.<br>
    <a href="https://developer.mozilla.org/en-US/docs/Web/API/Streams_API/Using_readable_byte_streams" class="_attribution-link">https://developer.mozilla.org/en-US/docs/Web/API/Streams_API/Using_readable_byte_streams</a>
  </p>
</div>

				
			</div>
			<ins class="adsbygoogle"
     style="display:block"
     data-ad-client="ca-pub-2572770204602497"
     data-ad-slot="1992473792"
     data-ad-format="auto"
     data-full-width-responsive="true"></ins>
<script>
     (adsbygoogle = window.adsbygoogle || []).push({});
</script>
		</div>
	</section>

	</div>
	<svg style="display:none">
		<symbol id="icon-dir"><svg viewBox="0 0 20 20"><path d="M15 10c0 .3-.305.515-.305.515l-8.56 5.303c-.625.41-1.135.106-1.135-.67V4.853c0-.777.51-1.078 1.135-.67l8.56 5.305S15 9.702 15 10z"/></svg></symbol>
	  </svg>
</body>
</html>

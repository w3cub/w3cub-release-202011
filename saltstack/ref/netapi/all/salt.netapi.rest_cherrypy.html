
<!DOCTYPE HTML>

<html lang="en" class="_theme-default">

<head>
  <meta charset="utf-8">
  <title>Rest_cherrypy - SaltStack - W3cubDocs</title>
  
  <meta name="description" content=" CherryPy Python module. ">
  <meta name="keywords" content="rest, cherrypy, saltstack">
  <meta name="HandheldFriendly" content="True">
  <meta name="MobileOptimized" content="320">
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <meta name="mobile-web-app-capable" content="yes">
  
  <link rel="canonical" href="https://docs.w3cub.com/saltstack/ref/netapi/all/salt.netapi.rest_cherrypy.html">
  <link href="/favicon.png" rel="icon">
  <link rel="stylesheet" type="text/css" href="/assets/application-e4ebd3a2a5652ff55173659804c4390a004917f3bdd17b5bb3ba78ea5c9c46fe181cadaac34517ccd815f5bdc982bbfe67179d6f4ac2f084ef2265e2a3dc8dc5.css" integrity="sha512-5OvToqVlL/VRc2WYBMQ5CgBJF/O90Xtbs7p46lycRv4YHK2qw0UXzNgV9b3Jgrv+Zxedb0rC8ITvImXio9yNxQ==" crossorigin="anonymous">
  <script type="text/javascript" integrity="sha512-EpkDeu98lN/jPKijllzVWdRg/dUSSMCaldYZNFz6bcNoBvpWRNz0HSTRQJ3ENmQc5Cuj1zDW1vHd7b0DzpOgyA==" crossorigin="anonymous" src="/assets/application-1299037aef7c94dfe33ca8a3965cd559d460fdd51248c09a95d619345cfa6dc36806fa5644dcf41d24d1409dc436641ce42ba3d730d6d6f1ddedbd03ce93a0c8.js"></script>
  <script src="/json/saltstack.js"></script>
  
  <script type="text/javascript">
    var _gaq = _gaq || [];
    _gaq.push(['_setAccount', 'UA-71174418-1']);
    _gaq.push(['_trackPageview']);

    (function() {
      var ga = document.createElement('script'); ga.type = 'text/javascript'; ga.async = true;
      ga.src = ('https:' == document.location.protocol ? 'https://ssl' : 'http://www') + '.google-analytics.com/ga.js';
      var s = document.getElementsByTagName('script')[0]; s.parentNode.insertBefore(ga, s);
    })();
  </script>
  <script data-ad-client="ca-pub-2572770204602497" async src="https://pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
  <script async custom-element="amp-auto-ads"
  src="https://cdn.ampproject.org/v0/amp-auto-ads-0.1.js">
</script>


</head>

<body>
	<amp-auto-ads type="adsense"
              data-ad-client="ca-pub-2572770204602497">
	</amp-auto-ads>
	<div class="_app">
	<header class="_header">
  
  <form class="_search">
    <input type="search" class="_search-input" placeholder="Search&hellip;" autocomplete="off" autocapitalize="off" autocorrect="off" spellcheck="false" maxlength="20">
    <a class="_search-clear"></a>
    <div class="_search-tag"></div>
  </form>
  
  <a class="_home-link" href="/" ></a>
  <a class="_menu-link"></a>
  <h1 class="_logo">
    <a href="/" class="_nav-link" title="API Documentation Browser">W3cubDocs</a>
  </h1>
  
  <span class="_logo-sub-nav">/</span><span class="_logo-sub-nav"><a href="/saltstack/" class="_nav-link" title="" style="margin-left:0;">SaltStack</a></span>
  
  <nav class="_nav">
    <a href="https://tools.w3cub.com/?_sp=docs" target="_blank" class="_nav-link ">W3cubTools</a>
    <a href="/cheatsheets/" class="_nav-link ">Cheatsheets</a>
    <a href="/about/" class="_nav-link ">About</a>
  </nav>
</header>
	<section class="_sidebar">
		<div class="_list-wrap">
			<div class="_list">
			
			</div>
		</div>
	</section>
	<section class="_container ">
		<div class="_content">
			<ins class="adsbygoogle"
     style="display:block"
     data-ad-client="ca-pub-2572770204602497"
     data-ad-slot="6861657091"
     data-ad-format="link"
     data-full-width-responsive="true"></ins>
<script>
     (adsbygoogle = window.adsbygoogle || []).push({});
</script>
			<div class="_page _simple">
				
				
<h1>rest_cherrypy</h1> <div class="contents local topic" id="contents"> <ul class="simple"> <li>
<a class="reference internal" href="#a-rest-api-for-salt" id="id3">A REST API for Salt</a><ul> <li><a class="reference internal" href="#authentication" id="id4">Authentication</a></li> <li><a class="reference internal" href="#usage" id="id5">Usage</a></li> <li><a class="reference internal" href="#content-negotiation" id="id6">Content negotiation</a></li> </ul> </li> <li>
<a class="reference internal" href="#performance-expectations-and-recommended-usage" id="id7">Performance Expectations and Recommended Usage</a><ul> <li><a class="reference internal" href="#long-running-http-connections" id="id8">Long-Running HTTP Connections</a></li> <li><a class="reference internal" href="#timeouts" id="id9">Timeouts</a></li> <li><a class="reference internal" href="#best-practices" id="id10">Best Practices</a></li> <li><a class="reference internal" href="#performance-tuning" id="id11">Performance Tuning</a></li> <li><a class="reference internal" href="#future-plans" id="id12">Future Plans</a></li> </ul> </li> <li>
<a class="reference internal" href="#deployment" id="id13">Deployment</a><ul> <li><a class="reference internal" href="#salt-api-using-the-cherrypy-server" id="id14"><strong class="program">salt-api</strong> using the CherryPy server</a></li> <li><a class="reference internal" href="#using-a-wsgi-compliant-web-server" id="id15">Using a WSGI-compliant web server</a></li> </ul> </li> <li>
<a class="reference internal" href="#rest-uri-reference" id="id16">REST URI Reference</a><ul> <li><a class="reference internal" href="#id2" id="id17"><code class="docutils literal notranslate"><span class="pre">/</span></code></a></li> <li><a class="reference internal" href="#login" id="id18"><code class="docutils literal notranslate"><span class="pre">/login</span></code></a></li> <li><a class="reference internal" href="#logout" id="id19"><code class="docutils literal notranslate"><span class="pre">/logout</span></code></a></li> <li><a class="reference internal" href="#minions" id="id20"><code class="docutils literal notranslate"><span class="pre">/minions</span></code></a></li> <li><a class="reference internal" href="#jobs" id="id21"><code class="docutils literal notranslate"><span class="pre">/jobs</span></code></a></li> <li><a class="reference internal" href="#run" id="id22"><code class="docutils literal notranslate"><span class="pre">/run</span></code></a></li> <li><a class="reference internal" href="#events" id="id23"><code class="docutils literal notranslate"><span class="pre">/events</span></code></a></li> <li><a class="reference internal" href="#hook" id="id24"><code class="docutils literal notranslate"><span class="pre">/hook</span></code></a></li> <li><a class="reference internal" href="#keys" id="id25"><code class="docutils literal notranslate"><span class="pre">/keys</span></code></a></li> <li><a class="reference internal" href="#ws" id="id26"><code class="docutils literal notranslate"><span class="pre">/ws</span></code></a></li> <li><a class="reference internal" href="#stats" id="id27"><code class="docutils literal notranslate"><span class="pre">/stats</span></code></a></li> </ul> </li> </ul> </div> <div class="section" id="a-rest-api-for-salt"> <h2><a class="toc-backref" href="#id3">A REST API for Salt</a></h2> <table class="docutils field-list" frame="void" rules="none"> <col class="field-name"> <col class="field-body"> <tbody valign="top"> <tr class="field-odd field">
<th class="field-name">depends:</th>
<td class="field-body">
<ul class="first"> <li>
<p class="first">CherryPy Python module.</p> <p>Note: there is a <a class="reference external" href="https://github.com/cherrypy/cherrypy/issues/1298">known SSL traceback for CherryPy versions 3.2.5 through 3.7.x</a>. Please use version 3.2.3 or the latest 10.x version instead.</p> </li> </ul> </td> </tr> <tr class="field-even field">
<th class="field-name">optdepends:</th>
<td class="field-body">
<ul class="first simple"> <li>ws4py Python module for websockets support.</li> </ul> </td> </tr> <tr class="field-odd field"><th class="field-name" colspan="2">client_libraries:</th></tr> <tr class="field-odd field">
<td> </td>
<td class="field-body">
<ul class="first simple"> <li>Java: <a class="reference external" href="https://github.com/SUSE/salt-netapi-client">https://github.com/SUSE/salt-netapi-client</a>
</li> <li>Python: <a class="reference external" href="https://github.com/saltstack/pepper">https://github.com/saltstack/pepper</a>
</li> </ul> </td> </tr> <tr class="field-even field">
<th class="field-name">setup:</th>
<td class="field-body">
<p class="first">All steps below are performed on the machine running the Salt Master daemon. Configuration goes into the Master configuration file.</p> <ol class="arabic"> <li>
<p class="first">Install <code class="docutils literal notranslate"><span class="pre">salt-api</span></code>. (This step varies between OS and Linux distros. Some package systems have a split package, others include salt-api in the main Salt package. Ensure the <code class="docutils literal notranslate"><span class="pre">salt-api</span> <span class="pre">--version</span></code> output matches the <code class="docutils literal notranslate"><span class="pre">salt</span> <span class="pre">--version</span></code> output.)</p> </li> <li>
<p class="first">Install CherryPy. (Read the version caveat in the section above.)</p> </li> <li>
<p class="first">Optional: generate self-signed SSL certificates.</p> <p>Using a secure HTTPS connection is strongly recommended since Salt eauth authentication credentials will be sent over the wire.</p> <ol class="arabic"> <li>
<p class="first">Install the PyOpenSSL package.</p> </li> <li>
<p class="first">Generate a self-signed certificate using the <a class="reference internal" href="../../modules/all/salt.modules.tls#salt.modules.tls.create_self_signed_cert" title="salt.modules.tls.create_self_signed_cert"><code class="xref py py-func docutils literal notranslate"><span class="pre">create_self_signed_cert()</span></code></a> execution function.</p> <pre class="highlight-bash notranslate" data-language="bash">salt-call --local tls.create_self_signed_cert</pre> </li> </ol> </li> <li>
<p class="first">Edit the master config to create at least one external auth user or group following the <a class="reference internal" href="https://docs.saltstack.com/en/latest/topics/eauth/index.html#acl-eauth"><span class="std std-ref">full external auth instructions</span></a>.</p> </li> <li>
<p class="first">Edit the master config with the following production-ready example to enable the <code class="docutils literal notranslate"><span class="pre">rest_cherrypy</span></code> module. (Adjust cert paths as needed, or disable SSL (not recommended!).)</p> <pre class="highlight-yaml notranslate" data-language="yaml">rest_cherrypy:
  port: 8000
  ssl_crt: /etc/pki/tls/certs/localhost.crt
  ssl_key: /etc/pki/tls/certs/localhost.key</pre> </li> <li>
<p class="first">Restart the <code class="docutils literal notranslate"><span class="pre">salt-master</span></code> daemon.</p> </li> <li>
<p class="first">Start the <code class="docutils literal notranslate"><span class="pre">salt-api</span></code> daemon.</p> </li> </ol> </td> </tr> <tr class="field-odd field">
<th class="field-name">configuration:</th>
<td class="field-body">
<p class="first">All available configuration options are detailed below. These settings configure the CherryPy HTTP server and do not apply when using an external server such as Apache or Nginx.</p> <dl class="last docutils"> <dt>port</dt> <dd>
<p class="first"><strong>Required</strong></p> <p class="last">The port for the webserver to listen on.</p> </dd> <dt>host <span class="classifier-delimiter">:</span> <span class="classifier"><code class="docutils literal notranslate"><span class="pre">0.0.0.0</span></code></span>
</dt> <dd>
<p class="first last">The socket interface for the HTTP server to listen on.</p> </dd> <dt>debug <span class="classifier-delimiter">:</span> <span class="classifier"><code class="docutils literal notranslate"><span class="pre">False</span></code></span>
</dt> <dd>
<p class="first last">Starts the web server in development mode. It will reload itself when the underlying code is changed and will output more debugging info.</p> </dd> <dt>log_access_file</dt> <dd>
<p class="first">Path to a file to write HTTP access logs.</p> <div class="last versionadded"> <p><span class="versionmodified">New in version 2016.11.0.</span></p> </div> </dd> <dt>log_error_file</dt> <dd>
<p class="first">Path to a file to write HTTP error logs.</p> <div class="last versionadded"> <p><span class="versionmodified">New in version 2016.11.0.</span></p> </div> </dd> <dt>ssl_crt</dt> <dd>
<p class="first last">The path to a SSL certificate. (See below)</p> </dd> <dt>ssl_key</dt> <dd>
<p class="first last">The path to the private key for your SSL certificate. (See below)</p> </dd> <dt>ssl_chain</dt> <dd>
<p class="first last">(Optional when using PyOpenSSL) the certificate chain to pass to <code class="docutils literal notranslate"><span class="pre">Context.load_verify_locations</span></code>.</p> </dd> <dt>disable_ssl</dt> <dd>
<p class="first last">A flag to disable SSL. Warning: your Salt authentication credentials will be sent in the clear!</p> </dd> <dt>webhook_disable_auth <span class="classifier-delimiter">:</span> <span class="classifier">False</span>
</dt> <dd>
<p class="first last">The <a class="reference internal" href="#salt.netapi.rest_cherrypy.app.Webhook" title="salt.netapi.rest_cherrypy.app.Webhook"><code class="xref py py-class docutils literal notranslate"><span class="pre">Webhook</span></code></a> URL requires authentication by default but external services cannot always be configured to send authentication. See the Webhook documentation for suggestions on securing this interface.</p> </dd> <dt>webhook_url <span class="classifier-delimiter">:</span> <span class="classifier">/hook</span>
</dt> <dd>
<p class="first last">Configure the URL endpoint for the <a class="reference internal" href="#salt.netapi.rest_cherrypy.app.Webhook" title="salt.netapi.rest_cherrypy.app.Webhook"><code class="xref py py-class docutils literal notranslate"><span class="pre">Webhook</span></code></a> entry point.</p> </dd> <dt>thread_pool <span class="classifier-delimiter">:</span> <span class="classifier"><code class="docutils literal notranslate"><span class="pre">100</span></code></span>
</dt> <dd>
<p class="first last">The number of worker threads to start up in the pool.</p> </dd> <dt>socket_queue_size <span class="classifier-delimiter">:</span> <span class="classifier"><code class="docutils literal notranslate"><span class="pre">30</span></code></span>
</dt> <dd>
<p class="first last">Specify the maximum number of HTTP connections to queue.</p> </dd> <dt>expire_responses <span class="classifier-delimiter">:</span> <span class="classifier">True</span>
</dt> <dd>
<p class="first">Whether to check for and kill HTTP responses that have exceeded the default timeout.</p> <div class="last deprecated"> <p><span class="versionmodified">Deprecated since version 2016.11.9,2017.7.3,2018.3.0: </span>The "expire_responses" configuration setting, which corresponds to the <code class="docutils literal notranslate"><span class="pre">timeout_monitor</span></code> setting in CherryPy, is no longer supported in CherryPy versions &gt;= 12.0.0.</p> </div> </dd> <dt>max_request_body_size <span class="classifier-delimiter">:</span> <span class="classifier"><code class="docutils literal notranslate"><span class="pre">1048576</span></code></span>
</dt> <dd>
<p class="first last">Maximum size for the HTTP request body.</p> </dd> <dt>collect_stats <span class="classifier-delimiter">:</span> <span class="classifier">False</span>
</dt> <dd>
<p class="first">Collect and report statistics about the CherryPy server</p> <p class="last">Reports are available via the <a class="reference internal" href="#salt.netapi.rest_cherrypy.app.Stats" title="salt.netapi.rest_cherrypy.app.Stats"><code class="xref py py-class docutils literal notranslate"><span class="pre">Stats</span></code></a> URL.</p> </dd> <dt>stats_disable_auth <span class="classifier-delimiter">:</span> <span class="classifier">False</span>
</dt> <dd>
<p class="first">Do not require authentication to access the <code class="docutils literal notranslate"><span class="pre">/stats</span></code> endpoint.</p> <div class="last versionadded"> <p><span class="versionmodified">New in version 2018.3.0.</span></p> </div> </dd> <dt>static</dt> <dd>
<p class="first last">A filesystem path to static HTML/JavaScript/CSS/image assets.</p> </dd> <dt>static_path <span class="classifier-delimiter">:</span> <span class="classifier"><code class="docutils literal notranslate"><span class="pre">/static</span></code></span>
</dt> <dd>
<p class="first last">The URL prefix to use when serving static assets out of the directory specified in the <code class="docutils literal notranslate"><span class="pre">static</span></code> setting.</p> </dd> <dt>enable_sessions <span class="classifier-delimiter">:</span> <span class="classifier"><code class="docutils literal notranslate"><span class="pre">True</span></code></span>
</dt> <dd>
<p class="first">Enable or disable all endpoints that rely on session cookies. This can be useful to enforce only header-based authentication.</p> <div class="last versionadded"> <p><span class="versionmodified">New in version 2017.7.0.</span></p> </div> </dd> <dt>app <span class="classifier-delimiter">:</span> <span class="classifier"><code class="docutils literal notranslate"><span class="pre">index.html</span></code></span>
</dt> <dd>
<p class="first">A filesystem path to an HTML file that will be served as a static file. This is useful for bootstrapping a single-page JavaScript app.</p> <p>Warning! If you set this option to a custom web application, anything that uses cookie-based authentication is vulnerable to XSRF attacks. Send the custom <code class="docutils literal notranslate"><span class="pre">X-Auth-Token</span></code> header instead and consider disabling the <code class="docutils literal notranslate"><span class="pre">enable_sessions</span></code> setting.</p> <div class="last versionchanged"> <p><span class="versionmodified">Changed in version 2017.7.0: </span>Add a proof-of-concept JavaScript single-page app.</p> </div> </dd> <dt>app_path <span class="classifier-delimiter">:</span> <span class="classifier"><code class="docutils literal notranslate"><span class="pre">/app</span></code></span>
</dt> <dd>
<p class="first">The URL prefix to use for serving the HTML file specified in the <code class="docutils literal notranslate"><span class="pre">app</span></code> setting. This should be a simple name containing no slashes.</p> <p class="last">Any path information after the specified path is ignored; this is useful for apps that utilize the HTML5 history API.</p> </dd> <dt>root_prefix <span class="classifier-delimiter">:</span> <span class="classifier"><code class="docutils literal notranslate"><span class="pre">/</span></code></span>
</dt> <dd>
<p class="first last">A URL path to the main entry point for the application. This is useful for serving multiple applications from the same URL.</p> </dd> </dl> </td> </tr> </tbody> </table> <div class="section" id="authentication"> <h3><a class="toc-backref" href="#id4">Authentication</a></h3> <p>Authentication is performed by passing a session token with each request. Tokens are generated via the <a class="reference internal" href="#salt.netapi.rest_cherrypy.app.Login" title="salt.netapi.rest_cherrypy.app.Login"><code class="xref py py-class docutils literal notranslate"><span class="pre">Login</span></code></a> URL.</p> <p>The token may be sent in one of two ways: as a custom header or as a session cookie. The latter is far more convenient for clients that support cookies.</p> <ul> <li>
<p class="first">Include a custom header named <em class="mailheader">X-Auth-Token</em>.</p> <p>For example, using curl:</p> <pre class="highlight-bash notranslate" data-language="bash">curl -sSk https://localhost:8000/login \
    -H 'Accept: application/x-yaml' \
    -d username=saltdev \
    -d password=saltdev \
    -d eauth=pam</pre> <p>Copy the <code class="docutils literal notranslate"><span class="pre">token</span></code> value from the output and include it in subsequent requests:</p> <pre class="highlight-bash notranslate" data-language="bash">curl -sSk https://localhost:8000 \
    -H 'Accept: application/x-yaml' \
    -H 'X-Auth-Token: 697adbdc8fe971d09ae4c2a3add7248859c87079'\
    -d client=local \
    -d tgt='*' \
    -d fun=test.ping</pre> </li> <li>
<p class="first">Sent via a cookie. This option is a convenience for HTTP clients that automatically handle cookie support (such as browsers).</p> <p>For example, using curl:</p> <pre class="highlight-bash notranslate" data-language="bash"># Write the cookie file:
curl -sSk https://localhost:8000/login \
      -c ~/cookies.txt \
      -H 'Accept: application/x-yaml' \
      -d username=saltdev \
      -d password=saltdev \
      -d eauth=auto

# Read the cookie file:
curl -sSk https://localhost:8000 \
      -b ~/cookies.txt \
      -H 'Accept: application/x-yaml' \
      -d client=local \
      -d tgt='*' \
      -d fun=test.ping</pre> <p>Another example using the <strong class="program">requests</strong> library in Python:</p> <pre class="highlight-python notranslate" data-language="python">&gt;&gt;&gt; import requests
&gt;&gt;&gt; session = requests.Session()
&gt;&gt;&gt; session.post('http://localhost:8000/login', json={
    'username': 'saltdev',
    'password': 'saltdev',
    'eauth': 'auto',
})
&lt;Response [200]&gt;
&gt;&gt;&gt; resp = session.post('http://localhost:8000', json=[{
    'client': 'local',
    'tgt': '*',
    'fun': 'test.arg',
    'arg': ['foo', 'bar'],
    'kwarg': {'baz': 'Baz!'},
}])
&gt;&gt;&gt; resp.json()
{u'return': [{
    ...snip...
}]}</pre> </li> </ul> <div class="admonition seealso"> <p class="first admonition-title">See also</p> <p class="last">You can bypass the session handling via the <a class="reference internal" href="#salt.netapi.rest_cherrypy.app.Run" title="salt.netapi.rest_cherrypy.app.Run"><code class="xref py py-class docutils literal notranslate"><span class="pre">Run</span></code></a> URL.</p> </div> </div> <div class="section" id="usage"> <h3><a class="toc-backref" href="#id5">Usage</a></h3> <p>This interface directly exposes Salt's <a class="reference internal" href="https://docs.saltstack.com/en/latest/ref/clients/index.html#python-api"><span class="std std-ref">Python API</span></a>. Everything possible at the CLI is possible through the Python API. Commands are executed on the Salt Master.</p> <p>The root URL (<code class="docutils literal notranslate"><span class="pre">/</span></code>) is RPC-like in that it accepts instructions in the request body for what Salt functions to execute, and the response contains the result of those function calls.</p> <p>For example:</p> <pre class="highlight-text notranslate" data-language="text">% curl -sSi https://localhost:8000         -H 'Content-type: application/json'         -d '[{
        "client": "local",
        "tgt": "*",
        "fun": "test.ping"
    }]'
HTTP/1.1 200 OK
Content-Type: application/json
[...snip...]

{"return": [{"jerry": true}]}</pre> <p>The request body must be an array of commands. Use this workflow to build a command:</p> <ol class="arabic simple"> <li>Choose a client interface.</li> <li>Choose a function.</li> <li>Fill out the remaining parameters needed for the chosen client.</li> </ol> <p>The <code class="docutils literal notranslate"><span class="pre">client</span></code> field is a reference to the main Python classes used in Salt's Python API. Read the full <a class="reference internal" href="https://docs.saltstack.com/en/latest/ref/clients/index.html#client-apis"><span class="std std-ref">Client APIs</span></a> documentation, but in short:</p> <ul class="simple"> <li>"local" uses <a class="reference internal" href="https://docs.saltstack.com/en/latest/ref/clients/index.html#salt.client.LocalClient" title="salt.client.LocalClient"><code class="xref py py-class docutils literal notranslate"><span class="pre">LocalClient</span></code></a> which sends commands to Minions. Equivalent to the <code class="docutils literal notranslate"><span class="pre">salt</span></code> CLI command.</li> <li>"runner" uses <a class="reference internal" href="https://docs.saltstack.com/en/latest/ref/clients/index.html#salt.runner.RunnerClient" title="salt.runner.RunnerClient"><code class="xref py py-class docutils literal notranslate"><span class="pre">RunnerClient</span></code></a> which invokes runner modules on the Master. Equivalent to the <code class="docutils literal notranslate"><span class="pre">salt-run</span></code> CLI command.</li> <li>"wheel" uses <a class="reference internal" href="https://docs.saltstack.com/en/latest/ref/clients/index.html#salt.wheel.WheelClient" title="salt.wheel.WheelClient"><code class="xref py py-class docutils literal notranslate"><span class="pre">WheelClient</span></code></a> which invokes wheel modules on the Master. Wheel modules do not have a direct CLI equivalent but they typically manage Master-side resources such as state files, pillar files, the Salt config files, and the <a class="reference internal" href="../../wheel/all/salt.wheel.key#module-salt.wheel.key" title="salt.wheel.key"><code class="xref py py-mod docutils literal notranslate"><span class="pre">key</span> <span class="pre">wheel</span> <span class="pre">module</span></code></a> exposes similar functionality as the <code class="docutils literal notranslate"><span class="pre">salt-key</span></code> CLI command.</li> </ul> <p>Most clients have variants like synchronous or asynchronous execution as well as others like batch execution. See the <a class="reference internal" href="https://docs.saltstack.com/en/latest/ref/clients/index.html#client-interfaces"><span class="std std-ref">full list of client interfaces</span></a>.</p> <p>Each client requires different arguments and sometimes has different syntax. For example, <code class="docutils literal notranslate"><span class="pre">LocalClient</span></code> requires the <code class="docutils literal notranslate"><span class="pre">tgt</span></code> argument because it forwards the command to Minions and the other client interfaces do not. <code class="docutils literal notranslate"><span class="pre">LocalClient</span></code> also takes <code class="docutils literal notranslate"><span class="pre">arg</span></code> (array) and <code class="docutils literal notranslate"><span class="pre">kwarg</span></code> (dictionary) arguments because these values are sent to the Minions and used to execute the requested function there. <code class="docutils literal notranslate"><span class="pre">RunnerClient</span></code> and <code class="docutils literal notranslate"><span class="pre">WheelClient</span></code> are executed directly on the Master and thus do not need or accept those arguments.</p> <p>Read the method signatures in the client documentation linked above, but hopefully an example will help illustrate the concept. This example causes Salt to execute two functions -- the <a class="reference internal" href="../../modules/all/salt.modules.test#salt.modules.test.arg" title="salt.modules.test.arg"><code class="xref py py-func docutils literal notranslate"><span class="pre">test.arg</span> <span class="pre">execution</span> <span class="pre">function</span></code></a> using <code class="docutils literal notranslate"><span class="pre">LocalClient</span></code> and the <a class="reference internal" href="../../runners/all/salt.runners.test#salt.runners.test.arg" title="salt.runners.test.arg"><code class="xref py py-func docutils literal notranslate"><span class="pre">test.arg</span>
<span class="pre">runner</span> <span class="pre">function</span></code></a> using <code class="docutils literal notranslate"><span class="pre">RunnerClient</span></code>; note the different structure for each command. The results for both are combined and returned as one response.</p> <pre class="highlight-text notranslate" data-language="text">% curl -b ~/cookies.txt -sSi localhost:8000         -H 'Content-type: application/json'         -d '
[
    {
        "client": "local",
        "tgt": "*",
        "fun": "test.arg",
        "arg": ["positional arg one", "positional arg two"],
        "kwarg": {
            "keyword arg one": "Hello from a minion",
            "keyword arg two": "Hello again from a minion"
        }
    },
    {
        "client": "runner",
        "fun": "test.arg",
        "keyword arg one": "Hello from a master",
        "keyword arg two": "Runners do not support positional args"
    }
]
'
HTTP/1.1 200 OK
[...snip...]
{
  "return": [
    {
      "jerry": {
        "args": [
          "positional arg one",
          "positional arg two"
        ],
        "kwargs": {
          "keyword arg one": "Hello from a minion",
          "keyword arg two": "Hello again from a minion",
          [...snip...]
        }
      },
      [...snip; other minion returns here...]
    },
    {
      "args": [],
      "kwargs": {
        "keyword arg two": "Runners do not support positional args",
        "keyword arg one": "Hello from a master"
      }
    }
  ]
}</pre> <p>One more example, this time with more commonly used functions:</p> <pre class="highlight-text notranslate" data-language="text">curl -b /tmp/cookies.txt -sSi localhost:8000         -H 'Content-type: application/json'         -d '
[
    {
        "client": "local",
        "tgt": "*",
        "fun": "state.sls",
        "kwarg": {
            "mods": "apache",
            "pillar": {
                "lookup": {
                    "wwwdir": "/srv/httpd/htdocs"
                }
            }
        }
    },
    {
        "client": "runner",
        "fun": "cloud.create",
        "provider": "my-ec2-provider",
        "instances": "my-centos-6",
        "image": "ami-1624987f",
        "delvol_on_destroy", true
    }
]
'
HTTP/1.1 200 OK
[...snip...]
{
  "return": [
    {
      "jerry": {
        "pkg_|-install_apache_|-httpd_|-installed": {
            [...snip full state return here...]
        }
      }
      [...snip other minion returns here...]
    },
    {
        [...snip full salt-cloud output here...]
    }
  ]
}</pre> </div> <div class="section" id="content-negotiation"> <h3><a class="toc-backref" href="#id6">Content negotiation</a></h3> <p>This REST interface is flexible in what data formats it will accept as well as what formats it will return (e.g., JSON, YAML, urlencoded).</p> <ul class="simple"> <li>Specify the format of data in the request body by including the <em class="mailheader">Content-Type</em> header.</li> <li>Specify the desired data format for the response body with the <em class="mailheader">Accept</em> header.</li> </ul> <p>We recommend the JSON format for most HTTP requests. urlencoded data is simple and cannot express complex data structures -- and that is often required for some Salt commands, such as starting a state run that uses Pillar data. Salt's CLI tool can reformat strings passed in at the CLI into complex data structures, and that behavior also works via salt-api, but that can be brittle and since salt-api can accept JSON it is best just to send JSON.</p> <p>Here is an example of sending urlencoded data:</p> <pre class="highlight-bash notranslate" data-language="bash">curl -sSik https://localhost:8000 \
    -b ~/cookies.txt \
    -d client=runner \
    -d fun='jobs.lookup_jid' \
    -d jid='20150129182456704682'</pre> <div class="admonition-urlencoded-data-caveats admonition"> <p class="first admonition-title">urlencoded data caveats</p> <ul> <li>
<p class="first">Only a single command may be sent per HTTP request.</p> </li> <li>
<p class="first">Repeating the <code class="docutils literal notranslate"><span class="pre">arg</span></code> parameter multiple times will cause those parameters to be combined into a single list.</p> <p>Note, some popular frameworks and languages (notably jQuery, PHP, and Ruby on Rails) will automatically append empty brackets onto repeated query string parameters. E.g., <code class="docutils literal notranslate"><span class="pre">?foo[]=fooone&amp;foo[]=footwo</span></code>. This is <strong>not</strong> supported; send <code class="docutils literal notranslate"><span class="pre">?foo=fooone&amp;foo=footwo</span></code> instead, or send JSON or YAML.</p> </li> </ul> <p>A note about <code class="docutils literal notranslate"><span class="pre">curl</span></code></p> <p>The <code class="docutils literal notranslate"><span class="pre">-d</span></code> flag to curl does <em>not</em> automatically urlencode data which can affect passwords and other data that contains characters that must be encoded. Use the <code class="docutils literal notranslate"><span class="pre">--data-urlencode</span></code> flag instead. E.g.:</p> <div class="last highlight-bash notranslate">
<div class="highlight"><pre>curl -ksi http://localhost:8000/login <span class="se">\</span>
-H <span class="s2">"Accept: application/json"</span> <span class="se">\</span>
-d <span class="nv">username</span><span class="o">=</span><span class="s1">'myapiuser'</span> <span class="se">\</span>
--data-urlencode <span class="nv">password</span><span class="o">=</span><span class="s1">'1234+'</span> <span class="se">\</span>
-d <span class="nv">eauth</span><span class="o">=</span><span class="s1">'pam'</span>
</pre></div> </div> </div> </div> </div> <div class="section" id="performance-expectations-and-recommended-usage"> <h2><a class="toc-backref" href="#id7">Performance Expectations and Recommended Usage</a></h2> <p>This module provides a thin wrapper around <a class="reference internal" href="https://docs.saltstack.com/en/latest/ref/clients/index.html#python-api"><span class="std std-ref">Salt's Python API</span></a>. Executing a Salt command via rest_cherrypy is directly analogous to executing a Salt command via Salt's CLI (which also uses the Python API) -- they share the same semantics, performance characteristics, and 98% of the same code. As a rule-of-thumb: if you wouldn't do it at the CLI don't do it via this API.</p> <div class="section" id="long-running-http-connections"> <h3><a class="toc-backref" href="#id8">Long-Running HTTP Connections</a></h3> <p>The CherryPy server is a production-ready, threading HTTP server written in Python. Because it makes use of a thread pool to process HTTP requests it is not ideally suited to maintaining large numbers of concurrent, synchronous connections. On moderate hardware with default settings it should top-out at around 30 to 50 concurrent connections.</p> <p>That number of long-running, synchronous Salt processes is also not ideal. Like at the CLI, each Salt command run will start a process that instantiates its own <code class="docutils literal notranslate"><span class="pre">LocalClient</span></code>, which instantiates its own listener to the Salt event bus, and sends out its own periodic <code class="docutils literal notranslate"><span class="pre">saltutil.find_job</span></code> queries to determine if a Minion is still running the command. Not exactly a lightweight operation.</p> </div> <div class="section" id="timeouts"> <h3><a class="toc-backref" href="#id9">Timeouts</a></h3> <p>In addition to the above resource overhead for long-running connections, there are the usual HTTP timeout semantics for the CherryPy server, any HTTP client being used, as well as any hardware in between such as proxies, gateways, or load balancers. rest_cherrypy can be configured not to time-out long responses via the <code class="docutils literal notranslate"><span class="pre">expire_responses</span></code> setting, and both <a class="reference internal" href="https://docs.saltstack.com/en/latest/ref/clients/index.html#salt.client.LocalClient" title="salt.client.LocalClient"><code class="xref py py-class docutils literal notranslate"><span class="pre">LocalClient</span></code></a> and <a class="reference internal" href="https://docs.saltstack.com/en/latest/ref/clients/index.html#salt.runner.RunnerClient" title="salt.runner.RunnerClient"><code class="xref py py-class docutils literal notranslate"><span class="pre">RunnerClient</span></code></a> have their own timeout parameters that may be passed as top-level keywords:</p> <pre class="highlight-bash notranslate" data-language="bash">curl -b /tmp/cookies.txt -sSi localhost:8000         -H 'Content-type: application/json'         -d '
[
    {
        "client": "local",
        "tgt": "*",
        "fun": "test.sleep",
        "kwarg": {"length": 30},
        "timeout": 60
    },
    {
        "client": "runner",
        "fun": "test.sleep",
        "kwarg": {"s_time": 30},
        "timeout": 60
    }
]
'</pre> </div> <div class="section" id="best-practices"> <h3><a class="toc-backref" href="#id10">Best Practices</a></h3> <p>Given the performance overhead and HTTP timeouts for long-running operations described above, the most effective and most scalable way to use both Salt and salt-api is to run commands asynchronously using the <code class="docutils literal notranslate"><span class="pre">local_async</span></code>, <code class="docutils literal notranslate"><span class="pre">runner_async</span></code>, and <code class="docutils literal notranslate"><span class="pre">wheel_async</span></code> clients.</p> <p>Running asynchronous jobs results in being able to process 3x more commands per second for <code class="docutils literal notranslate"><span class="pre">LocalClient</span></code> and 17x more commands per second for <code class="docutils literal notranslate"><span class="pre">RunnerClient</span></code>, in addition to much less network traffic and memory requirements. Job returns can be fetched from Salt's job cache via the <code class="docutils literal notranslate"><span class="pre">/jobs/&lt;jid&gt;</span></code> endpoint, or they can be collected into a data store using Salt's <a class="reference internal" href="https://docs.saltstack.com/en/latest/ref/returners/index.html#returners"><span class="std std-ref">Returner system</span></a>.</p> <p>The <code class="docutils literal notranslate"><span class="pre">/events</span></code> endpoint is specifically designed to handle long-running HTTP connections and it exposes Salt's event bus which includes job returns. Watching this endpoint first, then executing asynchronous Salt commands second, is the most lightweight and scalable way to use <code class="docutils literal notranslate"><span class="pre">rest_cherrypy</span></code> while still receiving job returns in real-time. But this requires clients that can properly handle the inherent asynchronicity of that workflow.</p> </div> <div class="section" id="performance-tuning"> <h3><a class="toc-backref" href="#id11">Performance Tuning</a></h3> <p>The <code class="docutils literal notranslate"><span class="pre">thread_pool</span></code> and <code class="docutils literal notranslate"><span class="pre">socket_queue_size</span></code> settings can be used to increase the capacity of rest_cherrypy to handle incoming requests. Keep an eye on RAM usage as well as available file handles while testing changes to these settings. As salt-api is a thin wrapper around Salt's Python API, also keep an eye on the performance of Salt when testing.</p> </div> <div class="section" id="future-plans"> <h3><a class="toc-backref" href="#id12">Future Plans</a></h3> <p>Now that Salt uses the Tornado concurrency library internally, we plan to improve performance in the API by taking advantage of existing processes and event listeners and to use lightweight coroutines to facilitate more simultaneous HTTP connections and better support for synchronous operations. That effort can be tracked in <a class="reference external" href="https://github.com/saltstack/salt/issues/26505">issue 26505</a>, but until that issue is closed rest_cherrypy will remain the officially recommended REST API.</p> </div> </div> <div class="section" id="deployment"> <h2><a class="toc-backref" href="#id13">Deployment</a></h2> <p>The <code class="docutils literal notranslate"><span class="pre">rest_cherrypy</span></code> netapi module is a standard Python WSGI app. It can be deployed one of two ways.</p> <div class="section" id="salt-api-using-the-cherrypy-server"> <h3><a class="toc-backref" href="#id14"><strong class="program">salt-api</strong> using the CherryPy server</a></h3> <p>The default configuration is to run this module using <strong class="program">salt-api</strong> to start the Python-based CherryPy server. This server is lightweight, multi-threaded, encrypted with SSL, and should be considered production-ready. See the section above for performance expectations.</p> </div> <div class="section" id="using-a-wsgi-compliant-web-server"> <h3><a class="toc-backref" href="#id15">Using a WSGI-compliant web server</a></h3> <p>This module may be deployed on any WSGI-compliant server such as Apache with mod_wsgi or Nginx with FastCGI, to name just two (there are many).</p> <p>Note, external WSGI servers handle URLs, paths, and SSL certs directly. The <code class="docutils literal notranslate"><span class="pre">rest_cherrypy</span></code> configuration options are ignored and the <code class="docutils literal notranslate"><span class="pre">salt-api</span></code> daemon does not need to be running at all. Remember Salt authentication credentials are sent in the clear unless SSL is being enforced!</p> <p>An example Apache virtual host configuration:</p> <pre class="highlight-default notranslate" data-language="default">&lt;VirtualHost *:80&gt;
    ServerName example.com
    ServerAlias *.example.com

    ServerAdmin webmaster@example.com

    LogLevel warn
    ErrorLog /var/www/example.com/logs/error.log
    CustomLog /var/www/example.com/logs/access.log combined

    DocumentRoot /var/www/example.com/htdocs

    WSGIScriptAlias / /path/to/salt/netapi/rest_cherrypy/wsgi.py
&lt;/VirtualHost&gt;</pre> </div> </div> <div class="section" id="rest-uri-reference"> <h2><a class="toc-backref" href="#id16">REST URI Reference</a></h2> <div class="section" id="id2"> <h3><a class="toc-backref" href="#id17"><code class="docutils literal notranslate"><span class="pre">/</span></code></a></h3> <dl class="class"> <dt id="salt.netapi.rest_cherrypy.app.LowDataAdapter"> <em class="property">class </em><code class="descclassname">salt.netapi.rest_cherrypy.app.</code><code class="descname">LowDataAdapter</code>
</dt> <dd>
<p>The primary entry point to Salt's REST API</p> <dl class="method"> <dt id="salt.netapi.rest_cherrypy.app.LowDataAdapter.GET"> <code class="descname">GET</code><span class="sig-paren">(</span><span class="sig-paren">)</span>
</dt> <dd>
<p>An explanation of the API with links of where to go next</p> <dl class="get"> <dt id="get--"> <code class="descname">GET </code><code class="descname">/</code>
</dt> <dd>
<table class="docutils field-list" frame="void" rules="none"> <col class="field-name"> <col class="field-body"> <tbody valign="top"> <tr class="field-odd field"><th class="field-name" colspan="2">Request Headers:</th></tr> <tr class="field-odd field">
<td> </td>
<td class="field-body">
<ul class="first simple"> <li>
<strong>Accept</strong> -- the desired response format.</li> </ul> </td> </tr> <tr class="field-even field">
<th class="field-name">Status Codes:</th>
<td class="field-body">
<ul class="first last simple"> <li>
<strong>200</strong> -- success</li> <li>
<strong>401</strong> -- authentication required</li> <li>
<strong>406</strong> -- requested Content-Type not available</li> </ul> </td> </tr> </tbody> </table> </dd>
</dl> <p><strong>Example request:</strong></p> <pre class="highlight-bash notranslate" data-language="bash">curl -i localhost:8000</pre> <pre class="highlight-text notranslate" data-language="text">GET / HTTP/1.1
Host: localhost:8000
Accept: application/json</pre> <p><strong>Example response:</strong></p> <pre class="highlight-text notranslate" data-language="text">HTTP/1.1 200 OK
Content-Type: application/json</pre> </dd>
</dl> <dl class="attribute"> <dt id="salt.netapi.rest_cherrypy.app.LowDataAdapter.POST"> <code class="descname">POST</code>
</dt> <dd>
<p>Mock out specified imports.</p> <p>This allows autodoc to do its thing without having oodles of req'd installed libs. This doesn't work with <code class="docutils literal notranslate"><span class="pre">import</span> <span class="pre">*</span></code> imports.</p> <p>This Mock class can be configured to return a specific values at specific names, if required.</p> <p><a class="reference external" href="http://read-the-docs.readthedocs.org/en/latest/faq.html#i-get-import-errors-on-libraries-that-depend-on-c-modules">http://read-the-docs.readthedocs.org/en/latest/faq.html#i-get-import-errors-on-libraries-that-depend-on-c-modules</a></p> </dd>
</dl> </dd>
</dl> </div> <div class="section" id="login"> <h3><a class="toc-backref" href="#id18"><code class="docutils literal notranslate"><span class="pre">/login</span></code></a></h3> <dl class="class"> <dt id="salt.netapi.rest_cherrypy.app.Login"> <em class="property">class </em><code class="descclassname">salt.netapi.rest_cherrypy.app.</code><code class="descname">Login</code><span class="sig-paren">(</span><em>*args</em>, <em>**kwargs</em><span class="sig-paren">)</span>
</dt> <dd>
<p>Log in to receive a session token</p> <p><a class="reference internal" href="#rest-cherrypy-auth"><span class="std std-ref">Authentication information</span></a>.</p> <dl class="method"> <dt id="salt.netapi.rest_cherrypy.app.Login.GET"> <code class="descname">GET</code><span class="sig-paren">(</span><span class="sig-paren">)</span>
</dt> <dd>
<p>Present the login interface</p> <dl class="get"> <dt id="get--login"> <code class="descname">GET </code><code class="descname">/login</code>
</dt> <dd>
<p>An explanation of how to log in.</p> <table class="docutils field-list" frame="void" rules="none"> <col class="field-name"> <col class="field-body"> <tbody valign="top"> <tr class="field-odd field">
<th class="field-name">Status Codes:</th>
<td class="field-body">
<ul class="first last simple"> <li>
<strong>200</strong> -- success</li> <li>
<strong>401</strong> -- authentication required</li> <li>
<strong>406</strong> -- requested Content-Type not available</li> </ul> </td> </tr> </tbody> </table> </dd>
</dl> <p><strong>Example request:</strong></p> <pre class="highlight-bash notranslate" data-language="bash">curl -i localhost:8000/login</pre> <pre class="highlight-text notranslate" data-language="text">GET /login HTTP/1.1
Host: localhost:8000
Accept: text/html</pre> <p><strong>Example response:</strong></p> <pre class="highlight-text notranslate" data-language="text">HTTP/1.1 200 OK
Content-Type: text/html</pre> </dd>
</dl> <dl class="method"> <dt id="salt.netapi.rest_cherrypy.app.Login.POST"> <code class="descname">POST</code><span class="sig-paren">(</span><em>**kwargs</em><span class="sig-paren">)</span>
</dt> <dd>
<p><a class="reference internal" href="#rest-cherrypy-auth"><span class="std std-ref">Authenticate</span></a> against Salt's eauth system</p> <dl class="post"> <dt id="post--login"> <code class="descname">POST </code><code class="descname">/login</code>
</dt> <dd>
<table class="docutils field-list" frame="void" rules="none"> <col class="field-name"> <col class="field-body"> <tbody valign="top"> <tr class="field-odd field"><th class="field-name" colspan="2">Request Headers:</th></tr> <tr class="field-odd field">
<td> </td>
<td class="field-body">
<ul class="first simple"> <li>
<strong>X-Auth-Token</strong> -- a session token from <a class="reference internal" href="#salt.netapi.rest_cherrypy.app.Login" title="salt.netapi.rest_cherrypy.app.Login"><code class="xref py py-class docutils literal notranslate"><span class="pre">Login</span></code></a>.</li> <li>
<strong>Accept</strong> -- the desired response format.</li> <li>
<strong>Content-Type</strong> -- the format of the request body.</li> </ul> </td> </tr> <tr class="field-even field"><th class="field-name" colspan="2">Form Parameters:</th></tr> <tr class="field-even field">
<td> </td>
<td class="field-body">
<ul class="first simple"> <li>
<strong>eauth</strong> -- the eauth backend configured for the user</li> <li>
<strong>username</strong> -- username</li> <li>
<strong>password</strong> -- password</li> </ul> </td> </tr> <tr class="field-odd field">
<th class="field-name">Status Codes:</th>
<td class="field-body">
<ul class="first last simple"> <li>
<strong>200</strong> -- success</li> <li>
<strong>401</strong> -- authentication required</li> <li>
<strong>406</strong> -- requested Content-Type not available</li> </ul> </td> </tr> </tbody> </table> </dd>
</dl> <p><strong>Example request:</strong></p> <pre class="highlight-bash notranslate" data-language="bash">curl -si localhost:8000/login \
    -c ~/cookies.txt \
    -H "Accept: application/json" \
    -H "Content-type: application/json" \
    -d '{
        "username": "saltuser",
        "password": "saltuser",
        "eauth": "auto"
    }'</pre> <pre class="highlight-text notranslate" data-language="text">POST / HTTP/1.1
Host: localhost:8000
Content-Length: 42
Content-Type: application/json
Accept: application/json

{"username": "saltuser", "password": "saltuser", "eauth": "auto"}</pre> <p><strong>Example response:</strong></p> <pre class="highlight-text notranslate" data-language="text">HTTP/1.1 200 OK
Content-Type: application/json
Content-Length: 206
X-Auth-Token: 6d1b722e
Set-Cookie: session_id=6d1b722e; expires=Sat, 17 Nov 2012 03:23:52 GMT; Path=/

{"return": {
    "token": "6d1b722e",
    "start": 1363805943.776223,
    "expire": 1363849143.776224,
    "user": "saltuser",
    "eauth": "pam",
    "perms": [
        "grains.*",
        "status.*",
        "sys.*",
        "test.*"
    ]
}}</pre> </dd>
</dl> </dd>
</dl> </div> <div class="section" id="logout"> <h3><a class="toc-backref" href="#id19"><code class="docutils literal notranslate"><span class="pre">/logout</span></code></a></h3> <dl class="class"> <dt id="salt.netapi.rest_cherrypy.app.Logout"> <em class="property">class </em><code class="descclassname">salt.netapi.rest_cherrypy.app.</code><code class="descname">Logout</code>
</dt> <dd>
<p>Class to remove or invalidate sessions</p> <dl class="method"> <dt id="salt.netapi.rest_cherrypy.app.Logout.POST"> <code class="descname">POST</code><span class="sig-paren">(</span><span class="sig-paren">)</span>
</dt> <dd>
<p>Destroy the currently active session and expire the session cookie</p> </dd>
</dl> </dd>
</dl> </div> <div class="section" id="minions"> <h3><a class="toc-backref" href="#id20"><code class="docutils literal notranslate"><span class="pre">/minions</span></code></a></h3> <dl class="class"> <dt id="salt.netapi.rest_cherrypy.app.Minions"> <em class="property">class </em><code class="descclassname">salt.netapi.rest_cherrypy.app.</code><code class="descname">Minions</code>
</dt> <dd>
<p>Convenience URLs for working with minions</p> <dl class="method"> <dt id="salt.netapi.rest_cherrypy.app.Minions.GET"> <code class="descname">GET</code><span class="sig-paren">(</span><em>mid=None</em><span class="sig-paren">)</span>
</dt> <dd>
<p>A convenience URL for getting lists of minions or getting minion details</p> <dl class="get"> <dt id="get--minions-(mid)"> <code class="descname">GET </code><code class="descname">/minions/</code><span class="sig-paren">(</span><em>mid</em><span class="sig-paren">)</span>
</dt> <dd>
<table class="docutils field-list" frame="void" rules="none"> <col class="field-name"> <col class="field-body"> <tbody valign="top"> <tr class="field-odd field"><th class="field-name" colspan="2">Request Headers:</th></tr> <tr class="field-odd field">
<td> </td>
<td class="field-body">
<ul class="first simple"> <li>
<strong>X-Auth-Token</strong> -- a session token from <a class="reference internal" href="#salt.netapi.rest_cherrypy.app.Login" title="salt.netapi.rest_cherrypy.app.Login"><code class="xref py py-class docutils literal notranslate"><span class="pre">Login</span></code></a>.</li> <li>
<strong>Accept</strong> -- the desired response format.</li> </ul> </td> </tr> <tr class="field-even field">
<th class="field-name">Status Codes:</th>
<td class="field-body">
<ul class="first last simple"> <li>
<strong>200</strong> -- success</li> <li>
<strong>401</strong> -- authentication required</li> <li>
<strong>406</strong> -- requested Content-Type not available</li> </ul> </td> </tr> </tbody> </table> </dd>
</dl> <p><strong>Example request:</strong></p> <pre class="highlight-bash notranslate" data-language="bash">curl -i localhost:8000/minions/ms-3</pre> <pre class="highlight-text notranslate" data-language="text">GET /minions/ms-3 HTTP/1.1
Host: localhost:8000
Accept: application/x-yaml</pre> <p><strong>Example response:</strong></p> <pre class="highlight-text notranslate" data-language="text">HTTP/1.1 200 OK
Content-Length: 129005
Content-Type: application/x-yaml

return:
- ms-3:
    grains.items:
        ...</pre> </dd>
</dl> <dl class="method"> <dt id="salt.netapi.rest_cherrypy.app.Minions.POST"> <code class="descname">POST</code><span class="sig-paren">(</span><em>**kwargs</em><span class="sig-paren">)</span>
</dt> <dd>
<p>Start an execution command and immediately return the job id</p> <dl class="post"> <dt id="post--minions"> <code class="descname">POST </code><code class="descname">/minions</code>
</dt> <dd>
<table class="docutils field-list" frame="void" rules="none"> <col class="field-name"> <col class="field-body"> <tbody valign="top"> <tr class="field-odd field"><th class="field-name" colspan="2">Request Headers:</th></tr> <tr class="field-odd field">
<td> </td>
<td class="field-body">
<ul class="first simple"> <li>
<strong>X-Auth-Token</strong> -- a session token from <a class="reference internal" href="#salt.netapi.rest_cherrypy.app.Login" title="salt.netapi.rest_cherrypy.app.Login"><code class="xref py py-class docutils literal notranslate"><span class="pre">Login</span></code></a>.</li> <li>
<strong>Accept</strong> -- the desired response format.</li> <li>
<strong>Content-Type</strong> -- the format of the request body.</li> </ul> </td> </tr> <tr class="field-even field"><th class="field-name" colspan="2">Response Headers:</th></tr> <tr class="field-even field">
<td> </td>
<td class="field-body">
<ul class="first simple"> <li>
<strong>Content-Type</strong> -- the format of the response body; depends on the <em class="mailheader">Accept</em> request header.</li> </ul> </td> </tr> <tr class="field-odd field">
<th class="field-name">Status Codes:</th>
<td class="field-body">
<ul class="first last simple"> <li>
<strong>200</strong> -- success</li> <li>
<strong>400</strong> -- bad or malformed request</li> <li>
<strong>401</strong> -- authentication required</li> <li>
<strong>406</strong> -- requested Content-Type not available</li> </ul> </td> </tr> </tbody> </table> <p>Lowstate data describing Salt commands must be sent in the request body. The <code class="docutils literal notranslate"><span class="pre">client</span></code> option will be set to <code class="xref py py-meth docutils literal notranslate"><span class="pre">local_async()</span></code>.</p> </dd>
</dl> <p><strong>Example request:</strong></p> <pre class="highlight-bash notranslate" data-language="bash">curl -sSi localhost:8000/minions \
    -b ~/cookies.txt \
    -H "Accept: application/x-yaml" \
    -d '[{"tgt": "*", "fun": "status.diskusage"}]'</pre> <pre class="highlight-text notranslate" data-language="text">POST /minions HTTP/1.1
Host: localhost:8000
Accept: application/x-yaml
Content-Type: application/json

tgt=*&amp;fun=status.diskusage</pre> <p><strong>Example response:</strong></p> <pre class="highlight-text notranslate" data-language="text">HTTP/1.1 202 Accepted
Content-Length: 86
Content-Type: application/x-yaml

return:
- jid: '20130603122505459265'
  minions: [ms-4, ms-3, ms-2, ms-1, ms-0]
_links:
  jobs:
    - href: /jobs/20130603122505459265</pre> </dd>
</dl> </dd>
</dl> </div> <div class="section" id="jobs"> <h3><a class="toc-backref" href="#id21"><code class="docutils literal notranslate"><span class="pre">/jobs</span></code></a></h3> <dl class="class"> <dt id="salt.netapi.rest_cherrypy.app.Jobs"> <em class="property">class </em><code class="descclassname">salt.netapi.rest_cherrypy.app.</code><code class="descname">Jobs</code>
</dt> <dd>
<dl class="method"> <dt id="salt.netapi.rest_cherrypy.app.Jobs.GET"> <code class="descname">GET</code><span class="sig-paren">(</span><em>jid=None</em>, <em>timeout=''</em><span class="sig-paren">)</span>
</dt> <dd>
<p>A convenience URL for getting lists of previously run jobs or getting the return from a single job</p> <dl class="get"> <dt id="get--jobs-(jid)"> <code class="descname">GET </code><code class="descname">/jobs/</code><span class="sig-paren">(</span><em>jid</em><span class="sig-paren">)</span>
</dt> <dd>
<p>List jobs or show a single job from the job cache.</p> <table class="docutils field-list" frame="void" rules="none"> <col class="field-name"> <col class="field-body"> <tbody valign="top"> <tr class="field-odd field"><th class="field-name" colspan="2">Request Headers:</th></tr> <tr class="field-odd field">
<td> </td>
<td class="field-body">
<ul class="first simple"> <li>
<strong>X-Auth-Token</strong> -- a session token from <a class="reference internal" href="#salt.netapi.rest_cherrypy.app.Login" title="salt.netapi.rest_cherrypy.app.Login"><code class="xref py py-class docutils literal notranslate"><span class="pre">Login</span></code></a>.</li> <li>
<strong>Accept</strong> -- the desired response format.</li> </ul> </td> </tr> <tr class="field-even field">
<th class="field-name">Status Codes:</th>
<td class="field-body">
<ul class="first last simple"> <li>
<strong>200</strong> -- success</li> <li>
<strong>401</strong> -- authentication required</li> <li>
<strong>406</strong> -- requested Content-Type not available</li> </ul> </td> </tr> </tbody> </table> </dd>
</dl> <p><strong>Example request:</strong></p> <pre class="highlight-bash notranslate" data-language="bash">curl -i localhost:8000/jobs</pre> <pre class="highlight-text notranslate" data-language="text">GET /jobs HTTP/1.1
Host: localhost:8000
Accept: application/x-yaml</pre> <p><strong>Example response:</strong></p> <pre class="highlight-text notranslate" data-language="text">HTTP/1.1 200 OK
Content-Length: 165
Content-Type: application/x-yaml

return:
- '20121130104633606931':
    Arguments:
    - '3'
    Function: test.fib
    Start Time: 2012, Nov 30 10:46:33.606931
    Target: jerry
    Target-type: glob</pre> <p><strong>Example request:</strong></p> <pre class="highlight-bash notranslate" data-language="bash">curl -i localhost:8000/jobs/20121130104633606931</pre> <pre class="highlight-text notranslate" data-language="text">GET /jobs/20121130104633606931 HTTP/1.1
Host: localhost:8000
Accept: application/x-yaml</pre> <p><strong>Example response:</strong></p> <pre class="highlight-text notranslate" data-language="text">HTTP/1.1 200 OK
Content-Length: 73
Content-Type: application/x-yaml

info:
- Arguments:
    - '3'
    Function: test.fib
    Minions:
    - jerry
    Start Time: 2012, Nov 30 10:46:33.606931
    Target: '*'
    Target-type: glob
    User: saltdev
    jid: '20121130104633606931'
return:
- jerry:
    - - 0
    - 1
    - 1
    - 2
    - 6.9141387939453125e-06</pre> </dd>
</dl> </dd>
</dl> </div> <div class="section" id="run"> <h3><a class="toc-backref" href="#id22"><code class="docutils literal notranslate"><span class="pre">/run</span></code></a></h3> <dl class="class"> <dt id="salt.netapi.rest_cherrypy.app.Run"> <em class="property">class </em><code class="descclassname">salt.netapi.rest_cherrypy.app.</code><code class="descname">Run</code>
</dt> <dd>
<p>Run commands bypassing the <a class="reference internal" href="#rest-cherrypy-auth"><span class="std std-ref">normal session handling</span></a></p> <p>salt-api does not enforce authorization, Salt's eauth system does that. Local/Runner/WheelClient all accept <code class="docutils literal notranslate"><span class="pre">username</span></code>/<code class="docutils literal notranslate"><span class="pre">password</span></code>/<code class="docutils literal notranslate"><span class="pre">eauth</span></code> <strong>or</strong> <code class="docutils literal notranslate"><span class="pre">token</span></code> kwargs that are then checked by the eauth system. The session mechanism in <code class="docutils literal notranslate"><span class="pre">rest_cherrypy</span></code> simply pairs a session with a Salt eauth token and then passes the <code class="docutils literal notranslate"><span class="pre">token</span></code> kwarg in automatically.</p> <p>If you already have a Salt eauth token, perhaps generated by the <a class="reference internal" href="../../runners/all/salt.runners.auth#salt.runners.auth.mk_token" title="salt.runners.auth.mk_token"><code class="xref py py-func docutils literal notranslate"><span class="pre">mk_token</span></code></a> function in the Auth Runner module, then there is no reason to use sessions.</p> <p>This endpoint accepts either a <code class="docutils literal notranslate"><span class="pre">username</span></code>, <code class="docutils literal notranslate"><span class="pre">password</span></code>, <code class="docutils literal notranslate"><span class="pre">eauth</span></code> trio, <strong>or</strong> a <code class="docutils literal notranslate"><span class="pre">token</span></code> kwarg and does not make use of sessions at all.</p> <dl class="method"> <dt id="salt.netapi.rest_cherrypy.app.Run.POST"> <code class="descname">POST</code><span class="sig-paren">(</span><em>**kwargs</em><span class="sig-paren">)</span>
</dt> <dd>
<p>Run commands bypassing the <a class="reference internal" href="#rest-cherrypy-auth"><span class="std std-ref">normal session handling</span></a> Other than that this URL is identical to the <a class="reference internal" href="#salt.netapi.rest_cherrypy.app.LowDataAdapter.POST" title="salt.netapi.rest_cherrypy.app.LowDataAdapter.POST"><code class="xref py py-meth docutils literal notranslate"><span class="pre">root</span> <span class="pre">URL</span> <span class="pre">(/)</span></code></a>.</p> <dl class="post"> <dt id="post--run"> <code class="descname">POST </code><code class="descname">/run</code>
</dt> <dd>
<p>An array of lowstate data describing Salt commands must be sent in the request body.</p> <table class="docutils field-list" frame="void" rules="none"> <col class="field-name"> <col class="field-body"> <tbody valign="top"> <tr class="field-odd field">
<th class="field-name">Status Codes:</th>
<td class="field-body">
<ul class="first last simple"> <li>
<strong>200</strong> -- success</li> <li>
<strong>400</strong> -- bad or malformed request</li> <li>
<strong>401</strong> -- authentication required</li> <li>
<strong>406</strong> -- requested Content-Type not available</li> </ul> </td> </tr> </tbody> </table> </dd>
</dl> <p><strong>Example request:</strong></p> <pre class="highlight-bash notranslate" data-language="bash">curl -sS localhost:8000/run \
    -H 'Accept: application/x-yaml' \
    -H 'Content-type: application/json' \
    -d '[{
        "client": "local",
        "tgt": "*",
        "fun": "test.ping",
        "username": "saltdev",
        "password": "saltdev",
        "eauth": "auto"
    }]'</pre> <p><strong>Or</strong> using a Salt Eauth token:</p> <pre class="highlight-bash notranslate" data-language="bash">curl -sS localhost:8000/run \
    -H 'Accept: application/x-yaml' \
    -H 'Content-type: application/json' \
    -d '[{
        "client": "local",
        "tgt": "*",
        "fun": "test.ping",
        "token": "&lt;salt eauth token here&gt;"
    }]'</pre> <pre class="highlight-text notranslate" data-language="text">POST /run HTTP/1.1
Host: localhost:8000
Accept: application/x-yaml
Content-Length: 75
Content-Type: application/json

[{"client": "local", "tgt": "*", "fun": "test.ping", "username": "saltdev", "password": "saltdev", "eauth": "auto"}]</pre> <p><strong>Example response:</strong></p> <pre class="highlight-text notranslate" data-language="text">HTTP/1.1 200 OK
Content-Length: 73
Content-Type: application/x-yaml

return:
- ms-0: true
  ms-1: true
  ms-2: true
  ms-3: true
  ms-4: true</pre> <p>The /run enpoint can also be used to issue commands using the salt-ssh subsystem.</p> <p>When using salt-ssh, eauth credentials should not be supplied. Instead, authentication should be handled by the SSH layer itself. The use of the salt-ssh client does not require a salt master to be running. Instead, only a roster file must be present in the salt configuration directory.</p> <p>All SSH client requests are synchronous.</p> <p><strong>Example SSH client request:</strong></p> <pre class="highlight-bash notranslate" data-language="bash">curl -sS localhost:8000/run \
    -H 'Accept: application/x-yaml' \
    -d client='ssh' \
    -d tgt='*' \
    -d fun='test.ping'</pre> <pre class="highlight-text notranslate" data-language="text">POST /run HTTP/1.1
Host: localhost:8000
Accept: application/x-yaml
Content-Length: 75
Content-Type: application/x-www-form-urlencoded

client=ssh&amp;tgt=*&amp;fun=test.ping</pre> <p><strong>Example SSH response:</strong></p> <pre class="highlight-text notranslate" data-language="text">return:
- silver:
  fun: test.ping
  fun_args: []
  id: silver
  jid: '20141203103525666185'
  retcode: 0
  return: true
  success: true</pre> </dd>
</dl> </dd>
</dl> </div> <div class="section" id="events"> <h3><a class="toc-backref" href="#id23"><code class="docutils literal notranslate"><span class="pre">/events</span></code></a></h3> <dl class="class"> <dt id="salt.netapi.rest_cherrypy.app.Events"> <em class="property">class </em><code class="descclassname">salt.netapi.rest_cherrypy.app.</code><code class="descname">Events</code>
</dt> <dd>
<p>Expose the Salt event bus</p> <p>The event bus on the Salt master exposes a large variety of things, notably when executions are started on the master and also when minions ultimately return their results. This URL provides a real-time window into a running Salt infrastructure.</p> <div class="admonition seealso"> <p class="first admonition-title">See also</p> <p class="last"><a class="reference internal" href="https://docs.saltstack.com/en/latest/topics/event/index.html#events"><span class="std std-ref">Events &amp; Reactor</span></a></p> </div> <dl class="method"> <dt id="salt.netapi.rest_cherrypy.app.Events.GET"> <code class="descname">GET</code><span class="sig-paren">(</span><em>token=None</em>, <em>salt_token=None</em><span class="sig-paren">)</span>
</dt> <dd>
<p>An HTTP stream of the Salt master event bus</p> <p>This stream is formatted per the Server Sent Events (SSE) spec. Each event is formatted as JSON.</p> <dl class="get"> <dt id="get--events"> <code class="descname">GET </code><code class="descname">/events</code>
</dt> <dd>
<table class="docutils field-list" frame="void" rules="none"> <col class="field-name"> <col class="field-body"> <tbody valign="top"> <tr class="field-odd field">
<th class="field-name">Status Codes:</th>
<td class="field-body">
<ul class="first simple"> <li>
<strong>200</strong> -- success</li> <li>
<strong>401</strong> -- authentication required</li> <li>
<strong>406</strong> -- requested Content-Type not available</li> </ul> </td> </tr> <tr class="field-even field"><th class="field-name" colspan="2">Query Parameters:</th></tr> <tr class="field-even field">
<td> </td>
<td class="field-body">
<ul class="first last simple"> <li>
<strong>token</strong> -- <strong>optional</strong> parameter containing the token ordinarily supplied via the X-Auth-Token header in order to allow cross-domain requests in browsers that do not include CORS support in the EventSource API. E.g., <code class="docutils literal notranslate"><span class="pre">curl</span> <span class="pre">-NsS</span> <span class="pre">localhost:8000/events?token=308650d</span></code>
</li> <li>
<strong>salt_token</strong> -- <strong>optional</strong> parameter containing a raw Salt <em>eauth token</em> (not to be confused with the token returned from the /login URL). E.g., <code class="docutils literal notranslate"><span class="pre">curl</span> <span class="pre">-NsS</span> <span class="pre">localhost:8000/events?salt_token=30742765</span></code>
</li> </ul> </td> </tr> </tbody> </table> </dd>
</dl> <p><strong>Example request:</strong></p> <pre class="highlight-bash notranslate" data-language="bash">curl -NsS localhost:8000/events</pre> <pre class="highlight-text notranslate" data-language="text">GET /events HTTP/1.1
Host: localhost:8000</pre> <p><strong>Example response:</strong></p> <p>Note, the <code class="docutils literal notranslate"><span class="pre">tag</span></code> field is not part of the spec. SSE compliant clients should ignore unknown fields. This addition allows non-compliant clients to only watch for certain tags without having to deserialze the JSON object each time.</p> <pre class="highlight-text notranslate" data-language="text">HTTP/1.1 200 OK
Connection: keep-alive
Cache-Control: no-cache
Content-Type: text/event-stream;charset=utf-8

retry: 400

tag: salt/job/20130802115730568475/new
data: {'tag': 'salt/job/20130802115730568475/new', 'data': {'minions': ['ms-4', 'ms-3', 'ms-2', 'ms-1', 'ms-0']}}

tag: salt/job/20130802115730568475/ret/jerry
data: {'tag': 'salt/job/20130802115730568475/ret/jerry', 'data': {'jid': '20130802115730568475', 'return': True, 'retcode': 0, 'success': True, 'cmd': '_return', 'fun': 'test.ping', 'id': 'ms-1'}}</pre> <p>The event stream can be easily consumed via JavaScript:</p> <pre class="highlight-javascript notranslate" data-language="javascript">var source = new EventSource('/events');
source.onopen = function() { console.info('Listening ...') };
source.onerror = function(err) { console.error(err) };
source.onmessage = function(message) {
    var saltEvent = JSON.parse(message.data);
    console.log(saltEvent.tag, saltEvent.data);
};</pre> <p>Note, the SSE stream is fast and completely asynchronous and Salt is very fast. If a job is created using a regular POST request, it is possible that the job return will be available on the SSE stream before the response for the POST request arrives. It is important to take that asynchronicity into account when designing an application. Below are some general guidelines.</p> <ul class="simple"> <li>Subscribe to the SSE stream _before_ creating any events.</li> <li>Process SSE events directly as they arrive and don't wait for any other process to "complete" first (like an ajax request).</li> <li>Keep a buffer of events if the event stream must be used for synchronous lookups.</li> <li>Be cautious in writing Salt's event stream directly to the DOM. It is very busy and can quickly overwhelm the memory allocated to a browser tab.</li> </ul> <p>A full, working proof-of-concept JavaScript application is available <a class="reference external" href="https://github.com/saltstack/salt/blob/develop/salt/netapi/rest_cherrypy/index.html">adjacent to this file</a>. It can be viewed by pointing a browser at the <code class="docutils literal notranslate"><span class="pre">/app</span></code> endpoint in a running <code class="docutils literal notranslate"><span class="pre">rest_cherrypy</span></code> instance.</p> <p>Or using CORS:</p> <pre class="highlight-javascript notranslate" data-language="javascript">var source = new EventSource('/events?token=ecd589e4e01912cf3c4035afad73426dbb8dba75', {withCredentials: true});</pre> <p>It is also possible to consume the stream via the shell.</p> <p>Records are separated by blank lines; the <code class="docutils literal notranslate"><span class="pre">data:</span></code> and <code class="docutils literal notranslate"><span class="pre">tag:</span></code> prefixes will need to be removed manually before attempting to unserialize the JSON.</p> <p>curl's <code class="docutils literal notranslate"><span class="pre">-N</span></code> flag turns off input buffering which is required to process the stream incrementally.</p> <p>Here is a basic example of printing each event as it comes in:</p> <pre class="highlight-bash notranslate" data-language="bash">curl -NsS localhost:8000/events |\
        while IFS= read -r line ; do
            echo $line
        done</pre> <p>Here is an example of using awk to filter events based on tag:</p> <pre class="highlight-bash notranslate" data-language="bash">curl -NsS localhost:8000/events |\
        awk '
            BEGIN { RS=""; FS="\\n" }
            $1 ~ /^tag: salt\/job\/[0-9]+\/new$/ { print $0 }
        '
tag: salt/job/20140112010149808995/new
data: {"tag": "salt/job/20140112010149808995/new", "data": {"tgt_type": "glob", "jid": "20140112010149808995", "tgt": "jerry", "_stamp": "2014-01-12_01:01:49.809617", "user": "shouse", "arg": [], "fun": "test.ping", "minions": ["jerry"]}}
tag: 20140112010149808995
data: {"tag": "20140112010149808995", "data": {"fun_args": [], "jid": "20140112010149808995", "return": true, "retcode": 0, "success": true, "cmd": "_return", "_stamp": "2014-01-12_01:01:49.819316", "fun": "test.ping", "id": "jerry"}}</pre> </dd>
</dl> </dd>
</dl> </div> <div class="section" id="hook"> <h3><a class="toc-backref" href="#id24"><code class="docutils literal notranslate"><span class="pre">/hook</span></code></a></h3> <dl class="class"> <dt id="salt.netapi.rest_cherrypy.app.Webhook"> <em class="property">class </em><code class="descclassname">salt.netapi.rest_cherrypy.app.</code><code class="descname">Webhook</code>
</dt> <dd>
<p>A generic web hook entry point that fires an event on Salt's event bus</p> <p>External services can POST data to this URL to trigger an event in Salt. For example, Amazon SNS, Jenkins-CI or Travis-CI, or GitHub web hooks.</p> <div class="admonition note"> <p class="first admonition-title">Note</p> <p>Be mindful of security</p> <p>Salt's Reactor can run any code. A Reactor SLS that responds to a hook event is responsible for validating that the event came from a trusted source and contains valid data.</p> <p><strong>This is a generic interface and securing it is up to you!</strong></p> <p class="last">This URL requires authentication however not all external services can be configured to authenticate. For this reason authentication can be selectively disabled for this URL. Follow best practices -- always use SSL, pass a secret key, configure the firewall to only allow traffic from a known source, etc.</p> </div> <p>The event data is taken from the request body. The <em class="mailheader">Content-Type</em> header is respected for the payload.</p> <p>The event tag is prefixed with <code class="docutils literal notranslate"><span class="pre">salt/netapi/hook</span></code> and the URL path is appended to the end. For example, a <code class="docutils literal notranslate"><span class="pre">POST</span></code> request sent to <code class="docutils literal notranslate"><span class="pre">/hook/mycompany/myapp/mydata</span></code> will produce a Salt event with the tag <code class="docutils literal notranslate"><span class="pre">salt/netapi/hook/mycompany/myapp/mydata</span></code>.</p> <p>The following is an example <code class="docutils literal notranslate"><span class="pre">.travis.yml</span></code> file to send notifications to Salt of successful test runs:</p> <pre class="highlight-yaml notranslate" data-language="yaml">language: python
script: python -m unittest tests
after_success:
    - |
        curl -sSk https://saltapi-url.example.com:8000/hook/travis/build/success                         -d branch="${TRAVIS_BRANCH}"                         -d commit="${TRAVIS_COMMIT}"</pre> <div class="admonition seealso"> <p class="first admonition-title">See also</p> <p class="last"><a class="reference internal" href="https://docs.saltstack.com/en/latest/topics/event/index.html#events"><span class="std std-ref">Events &amp; Reactor</span></a>, <a class="reference internal" href="https://docs.saltstack.com/en/latest/topics/reactor/index.html#reactor"><span class="std std-ref">reactor</span></a></p> </div> <dl class="method"> <dt id="salt.netapi.rest_cherrypy.app.Webhook.POST"> <code class="descname">POST</code><span class="sig-paren">(</span><em>*args</em>, <em>**kwargs</em><span class="sig-paren">)</span>
</dt> <dd>
<p>Fire an event in Salt with a custom event tag and data</p> <dl class="post"> <dt id="post--hook"> <code class="descname">POST </code><code class="descname">/hook</code>
</dt> <dd>
<table class="docutils field-list" frame="void" rules="none"> <col class="field-name"> <col class="field-body"> <tbody valign="top"> <tr class="field-odd field">
<th class="field-name">Status Codes:</th>
<td class="field-body">
<ul class="first last simple"> <li>
<strong>200</strong> -- success</li> <li>
<strong>401</strong> -- authentication required</li> <li>
<strong>406</strong> -- requested Content-Type not available</li> <li>
<strong>413</strong> -- request body is too large</li> </ul> </td> </tr> </tbody> </table> </dd>
</dl> <p><strong>Example request:</strong></p> <pre class="highlight-bash notranslate" data-language="bash">curl -sS localhost:8000/hook \
    -H 'Content-type: application/json' \
    -d '{"foo": "Foo!", "bar": "Bar!"}'</pre> <pre class="highlight-text notranslate" data-language="text">POST /hook HTTP/1.1
Host: localhost:8000
Content-Length: 16
Content-Type: application/json

{"foo": "Foo!", "bar": "Bar!"}</pre> <p><strong>Example response</strong>:</p> <pre class="highlight-text notranslate" data-language="text">HTTP/1.1 200 OK
Content-Length: 14
Content-Type: application/json

{"success": true}</pre> <p>As a practical example, an internal continuous-integration build server could send an HTTP POST request to the URL <code class="docutils literal notranslate"><span class="pre">https://localhost:8000/hook/mycompany/build/success</span></code> which contains the result of a build and the SHA of the version that was built as JSON. That would then produce the following event in Salt that could be used to kick off a deployment via Salt's Reactor:</p> <pre class="highlight-default notranslate" data-language="default">Event fired at Fri Feb 14 17:40:11 2014
*************************
Tag: salt/netapi/hook/mycompany/build/success
Data:
{'_stamp': '2014-02-14_17:40:11.440996',
    'headers': {
        'X-My-Secret-Key': 'F0fAgoQjIT@W',
        'Content-Length': '37',
        'Content-Type': 'application/json',
        'Host': 'localhost:8000',
        'Remote-Addr': '127.0.0.1'},
    'post': {'revision': 'aa22a3c4b2e7', 'result': True}}</pre> <p>Salt's Reactor could listen for the event:</p> <pre class="highlight-yaml notranslate" data-language="yaml">reactor:
  - 'salt/netapi/hook/mycompany/build/*':
    - /srv/reactor/react_ci_builds.sls</pre> <p>And finally deploy the new build:</p> <pre class="highlight-jinja notranslate" data-language="jinja">{% set secret_key = data.get('headers', {}).get('X-My-Secret-Key') %}
{% set build = data.get('post', {}) %}

{% if secret_key == 'F0fAgoQjIT@W' and build.result == True %}
deploy_my_app:
  cmd.state.sls:
    - tgt: 'application*'
    - arg:
      - myapp.deploy
    - kwarg:
        pillar:
          revision: {{ revision }}
{% endif %}</pre> </dd>
</dl> </dd>
</dl> </div> <div class="section" id="keys"> <h3><a class="toc-backref" href="#id25"><code class="docutils literal notranslate"><span class="pre">/keys</span></code></a></h3> <dl class="class"> <dt id="salt.netapi.rest_cherrypy.app.Keys"> <em class="property">class </em><code class="descclassname">salt.netapi.rest_cherrypy.app.</code><code class="descname">Keys</code>
</dt> <dd>
<p>Convenience URLs for working with minion keys</p> <div class="versionadded"> <p><span class="versionmodified">New in version 2014.7.0.</span></p> </div> <p>These URLs wrap the functionality provided by the <a class="reference internal" href="../../wheel/all/salt.wheel.key#module-salt.wheel.key" title="salt.wheel.key"><code class="xref py py-mod docutils literal notranslate"><span class="pre">key</span> <span class="pre">wheel</span>
<span class="pre">module</span></code></a> functions.</p> <dl class="method"> <dt id="salt.netapi.rest_cherrypy.app.Keys.GET"> <code class="descname">GET</code><span class="sig-paren">(</span><em>mid=None</em><span class="sig-paren">)</span>
</dt> <dd>
<p>Show the list of minion keys or detail on a specific key</p> <div class="versionadded"> <p><span class="versionmodified">New in version 2014.7.0.</span></p> </div> <dl class="get"> <dt id="get--keys-(mid)"> <code class="descname">GET </code><code class="descname">/keys/</code><span class="sig-paren">(</span><em>mid</em><span class="sig-paren">)</span>
</dt> <dd>
<p>List all keys or show a specific key</p> <table class="docutils field-list" frame="void" rules="none"> <col class="field-name"> <col class="field-body"> <tbody valign="top"> <tr class="field-odd field"><th class="field-name" colspan="2">Request Headers:</th></tr> <tr class="field-odd field">
<td> </td>
<td class="field-body">
<ul class="first simple"> <li>
<strong>X-Auth-Token</strong> -- a session token from <a class="reference internal" href="#salt.netapi.rest_cherrypy.app.Login" title="salt.netapi.rest_cherrypy.app.Login"><code class="xref py py-class docutils literal notranslate"><span class="pre">Login</span></code></a>.</li> <li>
<strong>Accept</strong> -- the desired response format.</li> </ul> </td> </tr> <tr class="field-even field">
<th class="field-name">Status Codes:</th>
<td class="field-body">
<ul class="first last simple"> <li>
<strong>200</strong> -- success</li> <li>
<strong>401</strong> -- authentication required</li> <li>
<strong>406</strong> -- requested Content-Type not available</li> </ul> </td> </tr> </tbody> </table> </dd>
</dl> <p><strong>Example request:</strong></p> <pre class="highlight-bash notranslate" data-language="bash">curl -i localhost:8000/keys</pre> <pre class="highlight-text notranslate" data-language="text">GET /keys HTTP/1.1
Host: localhost:8000
Accept: application/x-yaml</pre> <p><strong>Example response:</strong></p> <pre class="highlight-text notranslate" data-language="text">HTTP/1.1 200 OK
Content-Length: 165
Content-Type: application/x-yaml

return:
  local:
  - master.pem
  - master.pub
  minions:
  - jerry
  minions_pre: []
  minions_rejected: []</pre> <p><strong>Example request:</strong></p> <pre class="highlight-bash notranslate" data-language="bash">curl -i localhost:8000/keys/jerry</pre> <pre class="highlight-text notranslate" data-language="text">GET /keys/jerry HTTP/1.1
Host: localhost:8000
Accept: application/x-yaml</pre> <p><strong>Example response:</strong></p> <pre class="highlight-text notranslate" data-language="text">HTTP/1.1 200 OK
Content-Length: 73
Content-Type: application/x-yaml

return:
  minions:
    jerry: 51:93:b3:d0:9f:3a:6d:e5:28:67:c2:4b:27:d6:cd:2b</pre> </dd>
</dl> <dl class="method"> <dt id="salt.netapi.rest_cherrypy.app.Keys.POST"> <code class="descname">POST</code><span class="sig-paren">(</span><em>**kwargs</em><span class="sig-paren">)</span>
</dt> <dd>
<p>Easily generate keys for a minion and auto-accept the new key</p> <p>Accepts all the same parameters as the <a class="reference internal" href="../../wheel/all/salt.wheel.key#salt.wheel.key.gen_accept" title="salt.wheel.key.gen_accept"><code class="xref py py-func docutils literal notranslate"><span class="pre">key.gen_accept</span></code></a>.</p> <div class="admonition note"> <p class="first admonition-title">Note</p> <p class="last">A note about <code class="docutils literal notranslate"><span class="pre">curl</span></code> Avoid using the <code class="docutils literal notranslate"><span class="pre">-i</span></code> flag or HTTP headers will be written and produce an invalid tar file.</p> </div> <p>Example partial kickstart script to bootstrap a new minion:</p> <pre class="highlight-text notranslate" data-language="text">%post
mkdir -p /etc/salt/pki/minion
curl -sSk https://localhost:8000/keys \
        -d mid=jerry \
        -d username=kickstart \
        -d password=kickstart \
        -d eauth=pam \
    | tar -C /etc/salt/pki/minion -xf -

mkdir -p /etc/salt/minion.d
printf 'master: 10.0.0.5\nid: jerry' &gt; /etc/salt/minion.d/id.conf
%end</pre> <dl class="post"> <dt id="post--keys"> <code class="descname">POST </code><code class="descname">/keys</code>
</dt> <dd>
<p>Generate a public and private key and return both as a tarball</p> <p>Authentication credentials must be passed in the request.</p> <table class="docutils field-list" frame="void" rules="none"> <col class="field-name"> <col class="field-body"> <tbody valign="top"> <tr class="field-odd field">
<th class="field-name">Status Codes:</th>
<td class="field-body">
<ul class="first last simple"> <li>
<strong>200</strong> -- success</li> <li>
<strong>401</strong> -- authentication required</li> <li>
<strong>406</strong> -- requested Content-Type not available</li> </ul> </td> </tr> </tbody> </table> </dd>
</dl> <p><strong>Example request:</strong></p> <pre class="highlight-bash notranslate" data-language="bash">curl -sSk https://localhost:8000/keys \
        -d mid=jerry \
        -d username=kickstart \
        -d password=kickstart \
        -d eauth=pam \
        -o jerry-salt-keys.tar</pre> <pre class="highlight-text notranslate" data-language="text">POST /keys HTTP/1.1
Host: localhost:8000</pre> <p><strong>Example response:</strong></p> <pre class="highlight-text notranslate" data-language="text">HTTP/1.1 200 OK
Content-Length: 10240
Content-Disposition: attachment; filename="saltkeys-jerry.tar"
Content-Type: application/x-tar

jerry.pub0000644000000000000000000000070300000000000010730 0ustar  00000000000000</pre> </dd>
</dl> </dd>
</dl> </div> <div class="section" id="ws"> <h3><a class="toc-backref" href="#id26"><code class="docutils literal notranslate"><span class="pre">/ws</span></code></a></h3> <dl class="class"> <dt id="salt.netapi.rest_cherrypy.app.WebsocketEndpoint"> <em class="property">class </em><code class="descclassname">salt.netapi.rest_cherrypy.app.</code><code class="descname">WebsocketEndpoint</code>
</dt> <dd>
<p>Open a WebSocket connection to Salt's event bus</p> <p>The event bus on the Salt master exposes a large variety of things, notably when executions are started on the master and also when minions ultimately return their results. This URL provides a real-time window into a running Salt infrastructure. Uses websocket as the transport mechanism.</p> <div class="admonition seealso"> <p class="first admonition-title">See also</p> <p class="last"><a class="reference internal" href="https://docs.saltstack.com/en/latest/topics/event/index.html#events"><span class="std std-ref">Events &amp; Reactor</span></a></p> </div> <dl class="method"> <dt id="salt.netapi.rest_cherrypy.app.WebsocketEndpoint.GET"> <code class="descname">GET</code><span class="sig-paren">(</span><em>token=None</em>, <em>**kwargs</em><span class="sig-paren">)</span>
</dt> <dd>
<p>Return a websocket connection of Salt's event stream</p> <dl class="get"> <dt id="get--ws-(token)"> <code class="descname">GET </code><code class="descname">/ws/</code><span class="sig-paren">(</span><em>token</em><span class="sig-paren">)</span>
</dt> 
</dl> <table class="docutils field-list" frame="void" rules="none"> <col class="field-name"> <col class="field-body"> <tbody valign="top"> <tr class="field-odd field"><th class="field-name" colspan="2">Query format_events:</th></tr> <tr class="field-odd field">
<td> </td>
<td class="field-body">
<p class="first">The event stream will undergo server-side formatting if the <code class="docutils literal notranslate"><span class="pre">format_events</span></code> URL parameter is included in the request. This can be useful to avoid formatting on the client-side:</p> <pre class="highlight-bash notranslate" data-language="bash">curl -NsS &lt;...snip...&gt; localhost:8000/ws?format_events</pre> </td> </tr> <tr class="field-even field"><th class="field-name" colspan="2">Reqheader X-Auth-Token:</th></tr> <tr class="field-even field">
<td> </td>
<td class="field-body">
<p class="first">an authentication token from <a class="reference internal" href="#salt.netapi.rest_cherrypy.app.Login" title="salt.netapi.rest_cherrypy.app.Login"><code class="xref py py-class docutils literal notranslate"><span class="pre">Login</span></code></a>.</p> </td> </tr> <tr class="field-odd field">
<th class="field-name">Status 101:</th>
<td class="field-body">
<p class="first">switching to the websockets protocol</p> </td> </tr> <tr class="field-even field">
<th class="field-name">Status 401:</th>
<td class="field-body">
<p class="first">authentication required</p> </td> </tr> <tr class="field-odd field">
<th class="field-name">Status 406:</th>
<td class="field-body">
<p class="first last">requested Content-Type not available</p> </td> </tr> </tbody> </table> <p><strong>Example request:</strong></p> <pre class="highlight-default notranslate" data-language="default">curl -NsSk \
    -H 'X-Auth-Token: ffedf49d' \
    -H 'Host: localhost:8000' \
    -H 'Connection: Upgrade' \
    -H 'Upgrade: websocket' \
    -H 'Origin: https://localhost:8000' \
    -H 'Sec-WebSocket-Version: 13' \
    -H 'Sec-WebSocket-Key: '"$(echo -n $RANDOM | base64)" \
    localhost:8000/ws</pre> <pre class="highlight-text notranslate" data-language="text">GET /ws HTTP/1.1
Connection: Upgrade
Upgrade: websocket
Host: localhost:8000
Origin: https://localhost:8000
Sec-WebSocket-Version: 13
Sec-WebSocket-Key: s65VsgHigh7v/Jcf4nXHnA==
X-Auth-Token: ffedf49d</pre> <p><strong>Example response</strong>:</p> <pre class="highlight-text notranslate" data-language="text">HTTP/1.1 101 Switching Protocols
Upgrade: websocket
Connection: Upgrade
Sec-WebSocket-Accept: mWZjBV9FCglzn1rIKJAxrTFlnJE=
Sec-WebSocket-Version: 13</pre> <p>An authentication token <strong>may optionally</strong> be passed as part of the URL for browsers that cannot be configured to send the authentication header or cookie:</p> <pre class="highlight-bash notranslate" data-language="bash">curl -NsS &lt;...snip...&gt; localhost:8000/ws/ffedf49d</pre> <p>The event stream can be easily consumed via JavaScript:</p> <pre class="highlight-javascript notranslate" data-language="javascript">// Note, you must be authenticated!
var source = new Websocket('ws://localhost:8000/ws/d0ce6c1a');
source.onerror = function(e) { console.debug('error!', e); };
source.onmessage = function(e) { console.debug(e.data); };

source.send('websocket client ready')

source.close();</pre> <p>Or via Python, using the Python module <a class="reference external" href="https://pypi.python.org/pypi/websocket-client/">websocket-client</a> for example.</p> <pre class="highlight-python notranslate" data-language="python"># Note, you must be authenticated!

from websocket import create_connection

ws = create_connection('ws://localhost:8000/ws/d0ce6c1a')
ws.send('websocket client ready')

# Look at https://pypi.python.org/pypi/websocket-client/ for more
# examples.
while listening_to_events:
    print ws.recv()

ws.close()</pre> <p>Above examples show how to establish a websocket connection to Salt and activating real time updates from Salt's event stream by signaling <code class="docutils literal notranslate"><span class="pre">websocket</span> <span class="pre">client</span> <span class="pre">ready</span></code>.</p> </dd>
</dl> </dd>
</dl> </div> <div class="section" id="stats"> <h3><a class="toc-backref" href="#id27"><code class="docutils literal notranslate"><span class="pre">/stats</span></code></a></h3> <dl class="class"> <dt id="salt.netapi.rest_cherrypy.app.Stats"> <em class="property">class </em><code class="descclassname">salt.netapi.rest_cherrypy.app.</code><code class="descname">Stats</code>
</dt> <dd>
<p>Expose statistics on the running CherryPy server</p> <dl class="method"> <dt id="salt.netapi.rest_cherrypy.app.Stats.GET"> <code class="descname">GET</code><span class="sig-paren">(</span><span class="sig-paren">)</span>
</dt> <dd>
<p>Return a dump of statistics collected from the CherryPy server</p> <dl class="get"> <dt id="get--stats"> <code class="descname">GET </code><code class="descname">/stats</code>
</dt> <dd>
<table class="docutils field-list" frame="void" rules="none"> <col class="field-name"> <col class="field-body"> <tbody valign="top"> <tr class="field-odd field"><th class="field-name" colspan="2">Request Headers:</th></tr> <tr class="field-odd field">
<td> </td>
<td class="field-body">
<ul class="first simple"> <li>
<strong>X-Auth-Token</strong> -- a session token from <a class="reference internal" href="#salt.netapi.rest_cherrypy.app.Login" title="salt.netapi.rest_cherrypy.app.Login"><code class="xref py py-class docutils literal notranslate"><span class="pre">Login</span></code></a>.</li> <li>
<strong>Accept</strong> -- the desired response format.</li> </ul> </td> </tr> <tr class="field-even field"><th class="field-name" colspan="2">Response Headers:</th></tr> <tr class="field-even field">
<td> </td>
<td class="field-body">
<ul class="first simple"> <li>
<strong>Content-Type</strong> -- the format of the response body; depends on the <em class="mailheader">Accept</em> request header.</li> </ul> </td> </tr> <tr class="field-odd field">
<th class="field-name">Status Codes:</th>
<td class="field-body">
<ul class="first last simple"> <li>
<strong>200</strong> -- success</li> <li>
<strong>401</strong> -- authentication required</li> <li>
<strong>406</strong> -- requested Content-Type not available</li> </ul> </td> </tr> </tbody> </table> </dd>
</dl> </dd>
</dl> </dd>
</dl> </div> </div>
<div class="_attribution">
  <p class="_attribution-p">
     2019 SaltStack.<br>Licensed under the Apache License, Version 2.0.<br>
    <a href="https://docs.saltstack.com/en/latest/ref/netapi/all/salt.netapi.rest_cherrypy.html" class="_attribution-link">https://docs.saltstack.com/en/latest/ref/netapi/all/salt.netapi.rest_cherrypy.html</a>
  </p>
</div>

				
			</div>
			<ins class="adsbygoogle"
     style="display:block"
     data-ad-client="ca-pub-2572770204602497"
     data-ad-slot="1992473792"
     data-ad-format="auto"
     data-full-width-responsive="true"></ins>
<script>
     (adsbygoogle = window.adsbygoogle || []).push({});
</script>
		</div>
	</section>

	</div>
	<svg style="display:none">
		<symbol id="icon-dir"><svg viewBox="0 0 20 20"><path d="M15 10c0 .3-.305.515-.305.515l-8.56 5.303c-.625.41-1.135.106-1.135-.67V4.853c0-.777.51-1.078 1.135-.67l8.56 5.305S15 9.702 15 10z"/></svg></symbol>
	  </svg>
</body>
</html>

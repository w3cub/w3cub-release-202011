
<!DOCTYPE HTML>

<html lang="en" class="_theme-default">

<head>
  <meta charset="utf-8">
  <title>Writing Database Migrations - Django 1.11 - W3cubDocs</title>
  
  <meta name="description" content="This document explains how to structure and write database migrations for different scenarios you might encounter. For introductory material on &hellip;">
  <meta name="keywords" content="writing, database, migrations, django, django~1.11">
  <meta name="HandheldFriendly" content="True">
  <meta name="MobileOptimized" content="320">
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <meta name="mobile-web-app-capable" content="yes">
  
  <link rel="canonical" href="https://docs.w3cub.com/django~1.11/howto/writing-migrations.html">
  <link href="/favicon.png" rel="icon">
  <link rel="stylesheet" type="text/css" href="/assets/application-e4ebd3a2a5652ff55173659804c4390a004917f3bdd17b5bb3ba78ea5c9c46fe181cadaac34517ccd815f5bdc982bbfe67179d6f4ac2f084ef2265e2a3dc8dc5.css" integrity="sha512-5OvToqVlL/VRc2WYBMQ5CgBJF/O90Xtbs7p46lycRv4YHK2qw0UXzNgV9b3Jgrv+Zxedb0rC8ITvImXio9yNxQ==" crossorigin="anonymous">
  <script type="text/javascript" integrity="sha512-EpkDeu98lN/jPKijllzVWdRg/dUSSMCaldYZNFz6bcNoBvpWRNz0HSTRQJ3ENmQc5Cuj1zDW1vHd7b0DzpOgyA==" crossorigin="anonymous" src="/assets/application-1299037aef7c94dfe33ca8a3965cd559d460fdd51248c09a95d619345cfa6dc36806fa5644dcf41d24d1409dc436641ce42ba3d730d6d6f1ddedbd03ce93a0c8.js"></script>
  <script src="/json/django~1.11.js"></script>
  
  <script type="text/javascript">
    var _gaq = _gaq || [];
    _gaq.push(['_setAccount', 'UA-71174418-1']);
    _gaq.push(['_trackPageview']);

    (function() {
      var ga = document.createElement('script'); ga.type = 'text/javascript'; ga.async = true;
      ga.src = ('https:' == document.location.protocol ? 'https://ssl' : 'http://www') + '.google-analytics.com/ga.js';
      var s = document.getElementsByTagName('script')[0]; s.parentNode.insertBefore(ga, s);
    })();
  </script>
  <script data-ad-client="ca-pub-2572770204602497" async src="https://pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
  <script async custom-element="amp-auto-ads"
  src="https://cdn.ampproject.org/v0/amp-auto-ads-0.1.js">
</script>


</head>

<body>
	<amp-auto-ads type="adsense"
              data-ad-client="ca-pub-2572770204602497">
	</amp-auto-ads>
	<div class="_app">
	<header class="_header">
  
  <form class="_search">
    <input type="search" class="_search-input" placeholder="Search&hellip;" autocomplete="off" autocapitalize="off" autocorrect="off" spellcheck="false" maxlength="20">
    <a class="_search-clear"></a>
    <div class="_search-tag"></div>
  </form>
  
  <a class="_home-link" href="/" ></a>
  <a class="_menu-link"></a>
  <h1 class="_logo">
    <a href="/" class="_nav-link" title="API Documentation Browser">W3cubDocs</a>
  </h1>
  
  <span class="_logo-sub-nav">/</span><span class="_logo-sub-nav"><a href="/django~1.11/" class="_nav-link" title="" style="margin-left:0;">Django 1.11</a></span>
  
  <nav class="_nav">
    <a href="https://tools.w3cub.com/?_sp=docs" target="_blank" class="_nav-link ">W3cubTools</a>
    <a href="/cheatsheets/" class="_nav-link ">Cheatsheets</a>
    <a href="/about/" class="_nav-link ">About</a>
  </nav>
</header>
	<section class="_sidebar">
		<div class="_list-wrap">
			<div class="_list">
			
			</div>
		</div>
	</section>
	<section class="_container ">
		<div class="_content">
			<ins class="adsbygoogle"
     style="display:block"
     data-ad-client="ca-pub-2572770204602497"
     data-ad-slot="6861657091"
     data-ad-format="link"
     data-full-width-responsive="true"></ins>
<script>
     (adsbygoogle = window.adsbygoogle || []).push({});
</script>
			<div class="_page _sphinx">
				
				
<h1 id="writing-database-migrations">Writing database migrations</h1> <p id="s-writing-database-migrations">This document explains how to structure and write database migrations for different scenarios you might encounter. For introductory material on migrations, see <a class="reference internal" href="../topics/migrations"><span class="doc">the topic guide</span></a>.</p>  <h2 id="id1">Data migrations and multiple databases</h2> <p id="s-data-migrations-and-multiple-databases">When using multiple databases, you may need to figure out whether or not to run a migration against a particular database. For example, you may want to <strong>only</strong> run a migration on a particular database.</p> <p>In order to do that you can check the database connection’s alias inside a <code>RunPython</code> operation by looking at the <code>schema_editor.connection.alias</code> attribute:</p> <pre data-language="python">from django.db import migrations

def forwards(apps, schema_editor):
    if schema_editor.connection.alias != 'default':
        return
    # Your migration code goes here

class Migration(migrations.Migration):

    dependencies = [
        # Dependencies to other migrations
    ]

    operations = [
        migrations.RunPython(forwards),
    ]
</pre> <p>You can also provide hints that will be passed to the <a class="reference internal" href="../topics/db/multi-db#allow_migrate" title="allow_migrate"><code>allow_migrate()</code></a> method of database routers as <code>**hints</code>:</p> <pre data-language="python">class MyRouter(object):

    def allow_migrate(self, db, app_label, model_name=None, **hints):
        if 'target_db' in hints:
            return db == hints['target_db']
        return True
</pre> <p>Then, to leverage this in your migrations, do the following:</p> <pre data-language="python">from django.db import migrations

def forwards(apps, schema_editor):
    # Your migration code goes here
    ...

class Migration(migrations.Migration):

    dependencies = [
        # Dependencies to other migrations
    ]

    operations = [
        migrations.RunPython(forwards, hints={'target_db': 'default'}),
    ]
</pre> <p>If your <code>RunPython</code> or <code>RunSQL</code> operation only affects one model, it’s good practice to pass <code>model_name</code> as a hint to make it as transparent as possible to the router. This is especially important for reusable and third-party apps.</p>   <h2 id="migrations-that-add-unique-fields">Migrations that add unique fields</h2> <p id="s-migrations-that-add-unique-fields">Applying a “plain” migration that adds a unique non-nullable field to a table with existing rows will raise an error because the value used to populate existing rows is generated only once, thus breaking the unique constraint.</p> <p>Therefore, the following steps should be taken. In this example, we’ll add a non-nullable <a class="reference internal" href="../ref/models/fields#django.db.models.UUIDField" title="django.db.models.UUIDField"><code>UUIDField</code></a> with a default value. Modify the respective field according to your needs.</p> <ul> <li>Add the field on your model with <code>default=uuid.uuid4</code> and <code>unique=True</code> arguments (choose an appropriate default for the type of the field you’re adding). </li> <li>Run the <a class="reference internal" href="../ref/django-admin#django-admin-makemigrations"><code>makemigrations</code></a> command. This should generate a migration with an <code>AddField</code> operation. </li> <li>Generate two empty migration files for the same app by running <code>makemigrations myapp --empty</code> twice. We’ve renamed the migration files to give them meaningful names in the examples below. </li> <li>
<p class="first">Copy the <code>AddField</code> operation from the auto-generated migration (the first of the three new files) to the last migration, change <code>AddField</code> to <code>AlterField</code>, and add imports of <code>uuid</code> and <code>models</code>. For example:</p> <pre data-language="python"># -*- coding: utf-8 -*-
# Generated by Django A.B on YYYY-MM-DD HH:MM
from __future__ import unicode_literals

from django.db import migrations, models
import uuid

class Migration(migrations.Migration):

    dependencies = [
        ('myapp', '0005_populate_uuid_values'),
    ]

    operations = [
        migrations.AlterField(
            model_name='mymodel',
            name='uuid',
            field=models.UUIDField(default=uuid.uuid4, unique=True),
        ),
    ]
</pre> </li> <li>
<p class="first">Edit the first migration file. The generated migration class should look similar to this:</p> <pre data-language="python">class Migration(migrations.Migration):

    dependencies = [
        ('myapp', '0003_auto_20150129_1705'),
    ]

    operations = [
        migrations.AddField(
            model_name='mymodel',
            name='uuid',
            field=models.UUIDField(default=uuid.uuid4, unique=True),
        ),
    ]
</pre> <p>Change <code>unique=True</code> to <code>null=True</code> – this will create the intermediary null field and defer creating the unique constraint until we’ve populated unique values on all the rows.</p> </li> <li>
<p class="first">In the first empty migration file, add a <a class="reference internal" href="../ref/migration-operations#django.db.migrations.operations.RunPython" title="django.db.migrations.operations.RunPython"><code>RunPython</code></a> or <a class="reference internal" href="../ref/migration-operations#django.db.migrations.operations.RunSQL" title="django.db.migrations.operations.RunSQL"><code>RunSQL</code></a> operation to generate a unique value (UUID in the example) for each existing row. Also add an import of <code>uuid</code>. For example:</p> <pre data-language="python"># -*- coding: utf-8 -*-
# Generated by Django A.B on YYYY-MM-DD HH:MM
from __future__ import unicode_literals

from django.db import migrations
import uuid

def gen_uuid(apps, schema_editor):
    MyModel = apps.get_model('myapp', 'MyModel')
    for row in MyModel.objects.all():
        row.uuid = uuid.uuid4()
        row.save(update_fields=['uuid'])

class Migration(migrations.Migration):

    dependencies = [
        ('myapp', '0004_add_uuid_field'),
    ]

    operations = [
        # omit reverse_code=... if you don't want the migration to be reversible.
        migrations.RunPython(gen_uuid, reverse_code=migrations.RunPython.noop),
    ]
</pre> </li> <li>
<p class="first">Now you can apply the migrations as usual with the <a class="reference internal" href="../ref/django-admin#django-admin-migrate"><code>migrate</code></a> command.</p> <p>Note there is a race condition if you allow objects to be created while this migration is running. Objects created after the <code>AddField</code> and before <code>RunPython</code> will have their original <code>uuid</code>’s overwritten.</p> </li> </ul>  <h3 id="id2">Non-atomic migrations</h3> <div class="versionadded" id="s-non-atomic-migrations"> <span class="title">New in Django 1.10.</span> </div> <p>On databases that support DDL transactions (SQLite and PostgreSQL), migrations will run inside a transaction by default. For use cases such as performing data migrations on large tables, you may want to prevent a migration from running in a transaction by setting the <code>atomic</code> attribute to <code>False</code>:</p> <pre data-language="python">from django.db import migrations

class Migration(migrations.Migration):
    atomic = False
</pre> <p>Within such a migration, all operations are run without a transaction. It’s possible to execute parts of the migration inside a transaction using <a class="reference internal" href="../topics/db/transactions#django.db.transaction.atomic" title="django.db.transaction.atomic"><code>atomic()</code></a> or by passing <code>atomic=True</code> to <code>RunPython</code>.</p> <p>Here’s an example of a non-atomic data migration that updates a large table in smaller batches:</p> <pre data-language="python">import uuid

from django.db import migrations, transaction

def gen_uuid(apps, schema_editor):
    MyModel = apps.get_model('myapp', 'MyModel')
    while MyModel.objects.filter(uuid__isnull=True).exists():
        with transaction.atomic():
            for row in MyModel.objects.filter(uuid__isnull=True)[:1000]:
                row.uuid = uuid.uuid4()
                row.save()

class Migration(migrations.Migration):
    atomic = False

    operations = [
        migrations.RunPython(gen_uuid),
    ]
</pre> <p>The <code>atomic</code> attribute doesn’t have an effect on databases that don’t support DDL transactions (e.g. MySQL, Oracle).</p>    <h2 id="controlling-the-order-of-migrations">Controlling the order of migrations</h2> <p id="s-controlling-the-order-of-migrations">Django determines the order in which migrations should be applied not by the filename of each migration, but by building a graph using two properties on the <code>Migration</code> class: <code>dependencies</code> and <code>run_before</code>.</p> <p>If you’ve used the <a class="reference internal" href="../ref/django-admin#django-admin-makemigrations"><code>makemigrations</code></a> command you’ve probably already seen <code>dependencies</code> in action because auto-created migrations have this defined as part of their creation process.</p> <p>The <code>dependencies</code> property is declared like this:</p> <pre data-language="python">from django.db import migrations

class Migration(migrations.Migration):

    dependencies = [
        ('myapp', '0123_the_previous_migration'),
    ]
</pre> <p>Usually this will be enough, but from time to time you may need to ensure that your migration runs <em>before</em> other migrations. This is useful, for example, to make third-party apps’ migrations run <em>after</em> your <a class="reference internal" href="../ref/settings#std:setting-AUTH_USER_MODEL"><code>AUTH_USER_MODEL</code></a> replacement.</p> <p>To achieve this, place all migrations that should depend on yours in the <code>run_before</code> attribute on your <code>Migration</code> class:</p> <pre data-language="python">class Migration(migrations.Migration):
    ...

    run_before = [
        ('third_party_app', '0001_do_awesome'),
    ]
</pre> <p>Prefer using <code>dependencies</code> over <code>run_before</code> when possible. You should only use <code>run_before</code> if it is undesirable or impractical to specify <code>dependencies</code> in the migration which you want to run after the one you are writing.</p>   <h2 id="migrating-data-between-third-party-apps">Migrating data between third-party apps</h2> <p id="s-migrating-data-between-third-party-apps">You can use a data migration to move data from one third-party application to another.</p> <p>If you plan to remove the old app later, you’ll need to set the <code>dependencies</code> property based on whether or not the old app is installed. Otherwise, you’ll have missing dependencies once you uninstall the old app. Similarly, you’ll need to catch <a class="reference external" href="https://docs.python.org/3/library/exceptions.html#LookupError" title="(in Python v3.8)"><code>LookupError</code></a> in the <code>apps.get_model()</code> call that retrieves models from the old app. This approach allows you to deploy your project anywhere without first installing and then uninstalling the old app.</p> <p>Here’s a sample migration:</p> <pre data-language="python">from django.apps import apps as global_apps
from django.db import migrations

def forwards(apps, schema_editor):
    try:
        OldModel = apps.get_model('old_app', 'OldModel')
    except LookupError:
        # The old app isn't installed.
        return

    NewModel = apps.get_model('new_app', 'NewModel')
    NewModel.objects.bulk_create(
        NewModel(new_attribute=old_object.old_attribute)
        for old_object in OldModel.objects.all()
    )

class Migration(migrations.Migration):
    operations = [
        migrations.RunPython(forwards, migrations.RunPython.noop),
    ]
    dependencies = [
        ('myapp', '0123_the_previous_migration'),
        ('new_app', '0001_initial'),
    ]

    if global_apps.is_installed('old_app'):
        dependencies.append(('old_app', '0001_initial'))
</pre> <p>Also consider what you want to happen when the migration is unapplied. You could either do nothing (as in the example above) or remove some or all of the data from the new application. Adjust the second argument of the <a class="reference internal" href="../ref/migration-operations#django.db.migrations.operations.RunPython" title="django.db.migrations.operations.RunPython"><code>RunPython</code></a> operation accordingly.</p>   <h2 id="changing-an-unmanaged-model-to-managed">Changing an unmanaged model to managed</h2> <p id="s-changing-an-unmanaged-model-to-managed">If you want to change an unmanaged model (<a class="reference internal" href="../ref/models/options#django.db.models.Options.managed" title="django.db.models.Options.managed"><code>managed=False</code></a>) to managed, you must remove <code>managed=False</code> and generate a migration before making other schema-related changes to the model, since schema changes that appear in the migration that contains the operation to change <code>Meta.managed</code> may not be applied.</p>
<div class="_attribution">
  <p class="_attribution-p">
    © Django Software Foundation and individual contributors<br>Licensed under the BSD License.<br>
    <a href="https://docs.djangoproject.com/en/1.11/howto/writing-migrations/" class="_attribution-link">https://docs.djangoproject.com/en/1.11/howto/writing-migrations/</a>
  </p>
</div>

				
			</div>
			<ins class="adsbygoogle"
     style="display:block"
     data-ad-client="ca-pub-2572770204602497"
     data-ad-slot="1992473792"
     data-ad-format="auto"
     data-full-width-responsive="true"></ins>
<script>
     (adsbygoogle = window.adsbygoogle || []).push({});
</script>
		</div>
	</section>

	</div>
	<svg style="display:none">
		<symbol id="icon-dir"><svg viewBox="0 0 20 20"><path d="M15 10c0 .3-.305.515-.305.515l-8.56 5.303c-.625.41-1.135.106-1.135-.67V4.853c0-.777.51-1.078 1.135-.67l8.56 5.305S15 9.702 15 10z"/></svg></symbol>
	  </svg>
</body>
</html>
